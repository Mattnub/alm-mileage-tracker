<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALM Mileage Tracker v10</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #1c1c1c;
            border-right: 1px solid #2a2a2a;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 30px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #ffa726;
            margin-bottom: 5px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 0 20px;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #ffa726;
            color: #000;
            border-left-color: #ffa726;
        }

        .nav-item-icon {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            background: #141414;
        }

        /* Top Bar */
        .top-bar {
            background: #1c1c1c;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 30px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pill.maps-active {
            background: #22c55e;
            color: white;
        }

        .status-pill.sheets-signin {
            background: #ef4444;
            color: white;
        }

        .status-pill.total-miles {
            background: #ffa726;
            color: black;
            font-weight: 700;
        }

        /* Page Content */
        .page-content {
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Route Builder Card */
        .route-card {
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
        }

        .route-card-header {
            background: #252525;
            padding: 20px 25px;
            border-bottom: 1px solid #2a2a2a;
        }

        .section-title {
            color: #ffa726;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 16px;
            background: #ffa726;
            margin-right: 10px;
        }

        .route-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-field input,
        .form-field select {
            background: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px 15px;
            color: #fff;
            font-size: 14px;
        }

        .form-field input:focus,
        .form-field select:focus {
            border-color: #ffa726;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 167, 38, 0.1);
        }

        /* Route Builder */
        .route-builder {
            padding: 25px;
        }

        .stops-section {
            margin-bottom: 30px;
        }

        .stop-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 167, 38, 0.06);
            border: 1px solid rgba(255, 167, 38, 0.2);
            border-radius: 6px;
        }

        .stop-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .stop-indicator.start {
            background: #22c55e;
        }

        .stop-indicator.middle {
            background: #ffa726;
        }

        .stop-indicator.end {
            background: #ef4444;
        }

        .stop-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 80px;
        }

        .stop-select {
            flex: 1;
            background: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
        }

        .stop-distance {
            background: #ffa726;
            color: #000;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
        }

        .stop-remove {
            background: #333;
            border: none;
            color: #999;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stop-remove:hover {
            background: #ef4444;
            color: white;
        }

        .add-stop-btn {
            background: transparent;
            border: 1px dashed #666;
            color: #999;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-stop-btn:hover {
            border-color: #ffa726;
            color: #ffa726;
        }

        /* Day Total */
        .day-total {
            background: #252525;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .total-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .total-value {
            font-size: 36px;
            font-weight: 700;
            color: #ffa726;
        }

        .total-unit {
            font-size: 14px;
            color: #999;
            margin-left: 5px;
        }

        .total-note {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
        }

        /* Map Preview */
        .map-preview {
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .map-preview-header {
            background: #252525;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .map-preview-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffa726;
        }

        .map-container {
            width: 100%;
            height: 400px;
            background: #141414;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear {
            background: #333;
            color: #ccc;
        }

        .btn-clear:hover {
            background: #444;
        }

        .btn-preview {
            background: transparent;
            border: 1px solid #ffa726;
            color: #ffa726;
        }

        .btn-preview:hover {
            background: #ffa726;
            color: #000;
        }

        .btn-save {
            background: #ffa726;
            color: #000;
        }

        .btn-save:hover {
            background: #ff9800;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Draft Banner */
        .draft-banner {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: #000;
            padding: 15px 25px;
            margin-bottom: 25px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .draft-banner.show {
            display: block;
        }

        .draft-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .draft-btn {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.3);
            color: #000;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .draft-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #ffa726;
            color: #000;
        }

        /* Hidden pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .main-content {
                margin-left: 0;
            }

            .route-form {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-text">ALM</div>
                <div class="logo-subtitle">MILEAGE TRACKER v10</div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">LOG</div>
                <a href="#" class="nav-item active" data-page="log">
                    <span class="nav-item-icon">+</span>
                    New Route
                </a>
                <a href="#" class="nav-item" data-page="history">
                    <span class="nav-item-icon">‚è±</span>
                    Trip History
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">DATA</div>
                <a href="#" class="nav-item" data-page="locations">
                    <span class="nav-item-icon">üìç</span>
                    Locations
                </a>
                <a href="#" class="nav-item" data-page="matrix">
                    <span class="nav-item-icon">‚äû</span>
                    Distance Matrix
                </a>
                <a href="#" class="nav-item" onclick="refreshDistances()">
                    <span class="nav-item-icon">‚ü≤</span>
                    Refresh Distances
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ANALYSIS</div>
                <a href="#" class="nav-item" data-page="charts">
                    <span class="nav-item-icon">üìä</span>
                    Charts
                </a>
                <a href="#" class="nav-item" data-page="cost">
                    <span class="nav-item-icon">$</span>
                    Cost Report
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">EXPORT</div>
                <a href="#" class="nav-item" onclick="downloadExcel()">
                    <span class="nav-item-icon">‚Üì</span>
                    Download Excel
                </a>
                <a href="#" class="nav-item" onclick="importExcel()">
                    <span class="nav-item-icon">‚Üë</span>
                    Import Excel
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">APP</div>
                <a href="#" class="nav-item" data-page="changelog">
                    <span class="nav-item-icon">üìã</span>
                    Changelog
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="status-pill maps-active" id="maps-status">
                    ‚óè MAPS ACTIVE
                </div>
                <div class="status-pill sheets-signin" id="sheets-status">
                    ‚óè SHEETS: SIGN IN
                </div>
                <div class="status-pill total-miles">
                    <span id="total-miles-display">0.0</span> MI TOTAL
                </div>
            </div>

            <!-- Draft Banner -->
            <div class="draft-banner" id="draft-banner">
                DRAFT FOUND - You have an unsaved route in progress
                <div class="draft-actions">
                    <button class="draft-btn" onclick="resumeDraft()">Resume Draft</button>
                    <button class="draft-btn" onclick="discardDraft()">Discard Draft</button>
                </div>
            </div>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Log Trip Page -->
                <div class="page active" id="log-page">
                    <div class="page-header">
                        <h1 class="page-title">New Route</h1>
                        <p class="page-subtitle">BUILD YOUR DAY'S STOPS - UP TO 6 LOCATIONS</p>
                    </div>

                    <!-- Route Card -->
                    <div class="route-card">
                        <!-- Route Details Header -->
                        <div class="route-card-header">
                            <div class="section-title">Route Details</div>
                            <form class="route-form">
                                <div class="form-field">
                                    <label>Date</label>
                                    <input type="date" id="trip-date">
                                </div>
                                <div class="form-field">
                                    <label>Purpose</label>
                                    <select id="trip-purpose">
                                        <option value="">Dealership Visits</option>
                                        <option value="Sales Visit">Sales Visit</option>
                                        <option value="Service Call">Service Call</option>
                                        <option value="Training">Training</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <!-- Route Builder -->
                        <div class="route-builder">
                            <div class="stops-section">
                                <div id="stops-list">
                                    <!-- Stop items will be added dynamically -->
                                </div>
                                <button class="add-stop-btn" onclick="addStop()" id="add-stop-btn">
                                    + Add Stop
                                    <span id="stop-count">2 locations ‚Ä¢ 1 legs</span>
                                </button>
                            </div>

                            <!-- Day Total -->
                            <div class="day-total" id="day-total" style="display: none;">
                                <div class="total-label">Day Total</div>
                                <div class="total-value" id="total-value">
                                    0.0<span class="total-unit">miles</span>
                                </div>
                                <div class="total-note">Add stops to see breakdown</div>
                            </div>

                            <!-- Map Preview -->
                            <div class="map-preview" id="map-preview" style="display: none;">
                                <div class="map-preview-header">
                                    <div class="map-preview-title">Route Preview</div>
                                    <button class="btn btn-clear" onclick="toggleMapPreview()" id="map-toggle-btn">
                                        Hide Map
                                    </button>
                                </div>
                                <div class="map-container" id="map-container">
                                    <div>Loading route preview...</div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-clear" onclick="clearRoute()">Clear</button>
                                <button class="btn btn-preview" onclick="previewRoute()" id="preview-btn" disabled>
                                    Preview Route
                                </button>
                                <button class="btn btn-save" onclick="saveRoute()" id="save-btn" disabled>
                                    Save Route
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder pages -->
                <div class="page" id="history-page">
                    <div class="page-header">
                        <h1 class="page-title">Trip History</h1>
                        <p class="page-subtitle">VIEW AND MANAGE YOUR SAVED ROUTES</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Trip history functionality will be implemented here.</p>
                        </div>
                    </div>
                </div>

                <div class="page" id="locations-page">
                    <div class="page-header">
                        <h1 class="page-title">Locations</h1>
                        <p class="page-subtitle">ALM DEALERSHIP AND OFFICE LOCATIONS</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Location management will be implemented here.</p>
                        </div>
                    </div>
                </div>

                <div class="page" id="matrix-page">
                    <div class="page-header">
                        <h1 class="page-title">Distance Matrix</h1>
                        <p class="page-subtitle">LOCATION-TO-LOCATION DISTANCE GRID</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Distance matrix will be displayed here.</p>
                        </div>
                    </div>
                </div>

                <div class="page" id="charts-page">
                    <div class="page-header">
                        <h1 class="page-title">Charts</h1>
                        <p class="page-subtitle">MILEAGE ANALYTICS AND TRENDS</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Charts and analytics will be displayed here.</p>
                        </div>
                    </div>
                </div>

                <div class="page" id="cost-page">
                    <div class="page-header">
                        <h1 class="page-title">Cost Report</h1>
                        <p class="page-subtitle">REIMBURSEMENT CALCULATIONS</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Cost reporting will be implemented here.</p>
                        </div>
                    </div>
                </div>

                <div class="page" id="changelog-page">
                    <div class="page-header">
                        <h1 class="page-title">Changelog</h1>
                        <p class="page-subtitle">VERSION HISTORY AND UPDATES</p>
                    </div>
                    <div class="route-card">
                        <div class="route-builder">
                            <p style="color: #666; text-align: center; padding: 40px;">Version changelog will be displayed here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjlBfZykUSXuKi-O3OGJ4YTfiI4H3CpdE&callback=initMap&libraries=geometry"></script>

    <script>
        // Constants
        const MAX_STOPS = 6;
        const GOOGLE_API_KEY = 'AIzaSyBjlBfZykUSXuKi-O3OGJ4YTfiI4H3CpdE';
        const IRS_RATE = 0.70; // $0.70 per mile for 2025
        
        // ALM Locations (verified coordinates)
        const ALM_LOCATIONS = {
            'home': {
                name: 'Home',
                address: '216 Winterbury Dr, Canton, GA 30114',
                lat: 34.2364,
                lng: -84.4903,
                type: 'home'
            },
            'corporate': {
                name: 'ALM Corporate',
                address: '6625 The Corners Pkwy NW, Norcross, GA 30092',
                lat: 33.9410,
                lng: -84.2140,
                type: 'corporate'
            },
            'kennesaw': {
                name: 'ALM Kennesaw',
                address: '3905 Cherokee St NW, Kennesaw, GA 30144',
                lat: 34.0234,
                lng: -84.6199,
                type: 'dealership'
            },
            'marietta': {
                name: 'ALM Marietta',
                address: '750 Cobb Pkwy S, Marietta, GA 30060',
                lat: 33.9370,
                lng: -84.5220,
                type: 'dealership'
            },
            'gwinnett': {
                name: 'ALM Gwinnett',
                address: '2520 Pleasant Hill Rd, Duluth, GA 30096',
                lat: 33.9567,
                lng: -84.1442,
                type: 'dealership'
            },
            'buford': {
                name: 'ALM Buford',
                address: '4805 Browns Bridge Rd, Buford, GA 30518',
                lat: 34.1212,
                lng: -83.9932,
                type: 'dealership'
            },
            'roswell': {
                name: 'ALM Roswell',
                address: '11205 Alpharetta Hwy, Roswell, GA 30076',
                lat: 34.0754,
                lng: -84.3052,
                type: 'dealership'
            },
            'newnan': {
                name: 'ALM Newnan',
                address: '1405 Newnan Crossing Bypass, Newnan, GA 30265',
                lat: 33.3668,
                lng: -84.7796,
                type: 'dealership'
            },
            'mcdonough': {
                name: 'ALM McDonough',
                address: '1550 Highway 20/81 E, McDonough, GA 30253',
                lat: 33.4734,
                lng: -84.1468,
                type: 'dealership'
            }
        };

        // Global variables
        let currentRoute = [];
        let totalDistance = 0;
        let map = null;
        let directionsService = null;
        let directionsRenderer = null;
        let isMapInitialized = false;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkDraft();
            updateStatus();
        });

        function initializeApp() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trip-date').value = today;

            // Initialize route with 3 stops: START > STOP 1 > END
            initializeDefaultRoute();
            
            // Setup navigation
            setupNavigation();
            
            // Auto-save on changes
            setupAutoSave();
        }

        function initializeDefaultRoute() {
            // Clear any existing route
            currentRoute = [];
            document.getElementById('stops-list').innerHTML = '';
            
            // Add START stop (Home)
            addStopAtIndex(0, 'start', 'START', true);
            
            // Add middle stop (empty)
            addStopAtIndex(1, 'end', 'STOP 1 - END', false);
            
            // Update counters and buttons
            updateStopCounter();
            updateAddStopButton();
        }

        function addStopAtIndex(index, indicatorClass, labelText, autoSelectHome) {
            const stopsList = document.getElementById('stops-list');
            
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.dataset.index = index;
            
            stopItem.innerHTML = `
                <div class="stop-indicator ${indicatorClass}"></div>
                <div class="stop-label">${labelText}</div>
                <select class="stop-select" onchange="updateRoute(${index})">
                    <option value="">Choose location...</option>
                    ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                        `<option value="${key}">${loc.name}</option>`
                    ).join('')}
                </select>
                <div class="stop-distance" style="display: none;">0 mi</div>
                ${index > 0 ? `<button class="stop-remove" onclick="removeStop(${index})">√ó</button>` : ''}
            `;
            
            stopsList.appendChild(stopItem);
            currentRoute.push({ location: null, distance: 0 });
            
            // Auto-select Home for first stop
            if (autoSelectHome) {
                const select = stopItem.querySelector('select');
                select.value = 'home';
                currentRoute[index].location = 'home';
            }
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item[data-page]');
            const pages = document.querySelectorAll('.page');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = item.dataset.page;
                    
                    // Update active nav item
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update active page
                    pages.forEach(page => page.classList.remove('active'));
                    document.getElementById(`${targetPage}-page`).classList.add('active');
                });
            });
        }

        function setupAutoSave() {
            // Auto-save draft when inputs change
            const inputs = ['trip-date', 'trip-purpose'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', saveDraft);
                    element.addEventListener('change', saveDraft);
                }
            });
        }

        function addStop() {
            if (currentRoute.length >= MAX_STOPS) {
                showToast('Maximum 6 stops allowed', 'warning');
                return;
            }

            const stopsList = document.getElementById('stops-list');
            const stopIndex = currentRoute.length;
            
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.dataset.index = stopIndex;
            
            // All added stops are middle stops initially
            const indicatorClass = 'middle';
            const labelText = `STOP ${stopIndex} - END`;
            
            stopItem.innerHTML = `
                <div class="stop-indicator ${indicatorClass}"></div>
                <div class="stop-label">${labelText}</div>
                <select class="stop-select" onchange="updateRoute(${stopIndex})">
                    <option value="">Choose location...</option>
                    ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                        `<option value="${key}">${loc.name}</option>`
                    ).join('')}
                </select>
                <div class="stop-distance" style="display: none;">0 mi</div>
                <button class="stop-remove" onclick="removeStop(${stopIndex})">√ó</button>
            `;
            
            stopsList.appendChild(stopItem);
            currentRoute.push({ location: null, distance: 0 });
            
            // Update labels to ensure the last stop is marked as END
            updateStopLabels();
            
            // Update add button and stop count
            updateStopCounter();
            updateAddStopButton();
            saveDraft();
        }

        function updateStopCounter() {
            const validStops = currentRoute.filter(stop => stop.location).length;
            const legs = Math.max(0, validStops - 1);
            const counterText = `${validStops} locations ‚Ä¢ ${legs} legs`;
            
            const stopCount = document.getElementById('stop-count');
            if (stopCount) {
                stopCount.textContent = counterText;
            }
            
            // Update the add button text to reflect current state
            const addBtn = document.getElementById('add-stop-btn');
            if (addBtn) {
                const totalStops = currentRoute.length;
                const currentLegs = Math.max(0, totalStops - 1);
                addBtn.innerHTML = `+ Add Stop<span id="stop-count">${totalStops} locations ‚Ä¢ ${currentLegs} legs</span>`;
            }
        }

        function removeStop(index) {
            if (index === 0) {
                showToast('Cannot remove START location', 'warning');
                return;
            }
            
            if (currentRoute.length <= 2) {
                showToast('Must have at least 2 stops', 'warning');
                return;
            }
            
            const stopItem = document.querySelector(`[data-index="${index}"]`);
            if (stopItem) {
                stopItem.remove();
            }
            
            currentRoute.splice(index, 1);
            
            // Re-index remaining stops
            const stopItems = document.querySelectorAll('.stop-item');
            stopItems.forEach((item, i) => {
                item.dataset.index = i;
                const select = item.querySelector('select');
                const removeBtn = item.querySelector('.stop-remove');
                
                // Update onchange and onclick attributes
                select.setAttribute('onchange', `updateRoute(${i})`);
                if (removeBtn && i > 0) {
                    removeBtn.setAttribute('onclick', `removeStop(${i})`);
                }
            });
            
            // Update all labels and indicators
            updateStopLabels();
            updateStopCounter();
            updateAddStopButton();
            calculateRoute();
            saveDraft();
        }

        function updateRoute(index) {
            const stopItem = document.querySelector(`[data-index="${index}"]`);
            const select = stopItem.querySelector('select');
            const locationKey = select.value;
            
            if (locationKey && ALM_LOCATIONS[locationKey]) {
                currentRoute[index].location = locationKey;
                
                // Update labels and indicators
                updateStopLabels();
                updateStopCounter();
                calculateRoute();
                saveDraft();
            }
        }

        function updateStopLabels() {
            const stopItems = document.querySelectorAll('.stop-item');
            stopItems.forEach((item, i) => {
                const label = item.querySelector('.stop-label');
                const indicator = item.querySelector('.stop-indicator');
                
                if (i === 0) {
                    // First stop is always START
                    indicator.className = 'stop-indicator start';
                    label.textContent = 'START';
                } else if (i === currentRoute.length - 1) {
                    // Last stop is always END
                    indicator.className = 'stop-indicator end';
                    label.textContent = `STOP ${i} - END`;
                } else {
                    // Middle stops
                    indicator.className = 'stop-indicator middle';
                    label.textContent = `STOP ${i}`;
                }
            });
        }

        function updateAddStopButton() {
            const addBtn = document.getElementById('add-stop-btn');
            addBtn.style.display = currentRoute.length >= MAX_STOPS ? 'none' : 'inline-flex';
        }

        async function calculateRoute() {
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (validStops.length < 2) {
                resetDistanceDisplay();
                return;
            }

            try {
                const distanceMatrix = await getDistanceMatrix(validStops);
                updateDistanceDisplay(distanceMatrix);
                updateButtons();
            } catch (error) {
                console.error('Distance calculation error:', error);
                showToast('Error calculating distances', 'error');
            }
        }

        async function getDistanceMatrix(stops) {
            const service = new google.maps.DistanceMatrixService();
            const origins = stops.slice(0, -1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return new google.maps.LatLng(loc.lat, loc.lng);
            });
            const destinations = stops.slice(1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return new google.maps.LatLng(loc.lat, loc.lng);
            });

            return new Promise((resolve, reject) => {
                service.getDistanceMatrix({
                    origins: origins,
                    destinations: destinations,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL,
                    avoidHighways: false,
                    avoidTolls: false
                }, (response, status) => {
                    if (status === google.maps.DistanceMatrixStatus.OK) {
                        resolve(response);
                    } else {
                        reject(new Error(`Distance Matrix error: ${status}`));
                    }
                });
            });
        }

        function updateDistanceDisplay(distanceMatrix) {
            let totalMiles = 0;
            const elements = distanceMatrix.rows[0].elements;
            
            // Update individual leg distances
            elements.forEach((element, index) => {
                if (element.status === 'OK') {
                    const miles = Math.round(element.distance.value * 0.000621371 * 100) / 100;
                    totalMiles += miles;
                    
                    // Update leg badge
                    const stopItem = document.querySelector(`[data-index="${index + 1}"]`);
                    if (stopItem) {
                        const badge = stopItem.querySelector('.stop-distance');
                        badge.textContent = `${miles} mi`;
                        badge.style.display = 'block';
                    }
                }
            });
            
            // Update total display
            totalDistance = totalMiles;
            document.getElementById('total-value').innerHTML = `${totalMiles.toFixed(1)}<span class="total-unit">miles</span>`;
            document.getElementById('day-total').style.display = 'block';
            
            // Update top bar total
            document.getElementById('total-miles-display').textContent = totalMiles.toFixed(1);
            
            // Update status pill
            updateMapsStatus('connected');
        }

        function resetDistanceDisplay() {
            totalDistance = 0;
            document.getElementById('day-total').style.display = 'none';
            document.getElementById('total-miles-display').textContent = '0.0';
            
            // Hide leg badges
            document.querySelectorAll('.stop-distance').forEach(badge => {
                badge.style.display = 'none';
            });
            
            updateButtons();
        }

        function updateButtons() {
            const previewBtn = document.getElementById('preview-btn');
            const saveBtn = document.getElementById('save-btn');
            const hasValidRoute = currentRoute.filter(s => s.location).length >= 2;
            
            previewBtn.disabled = !hasValidRoute || totalDistance === 0;
            saveBtn.disabled = !hasValidRoute || totalDistance === 0;
        }

        // Google Maps Integration
        function initMap() {
            isMapInitialized = true;
            
            // Initialize map (hidden by default)
            map = new google.maps.Map(document.createElement('div'), {
                zoom: 10,
                center: { lat: 33.9490, lng: -84.3880 }, // Atlanta center
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [{"color": "#1d2c4d"}]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#8ec3b9"}]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#1a3646"}]
                    }
                    // Add more dark theme styles here...
                ]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions: {
                    strokeColor: '#ffa726',
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                }
            });

            updateMapsStatus('connected');
        }

        function previewRoute() {
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (validStops.length < 2) {
                showToast('Need at least 2 stops to preview route', 'warning');
                return;
            }

            if (!isMapInitialized) {
                showToast('Map is still loading, please wait...', 'warning');
                return;
            }

            // Show map preview section
            const mapSection = document.getElementById('map-preview');
            const mapContainer = document.getElementById('map-container');
            
            mapSection.style.display = 'block';
            
            // Replace placeholder with actual map
            mapContainer.innerHTML = '';
            map.getDiv().style.width = '100%';
            map.getDiv().style.height = '100%';
            mapContainer.appendChild(map.getDiv());
            
            // Trigger map resize
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
                displayRouteOnMap(validStops);
            }, 100);
            
            // Update toggle button
            document.getElementById('map-toggle-btn').textContent = 'Hide Map';
        }

        function displayRouteOnMap(stops) {
            const waypoints = stops.slice(1, -1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return {
                    location: new google.maps.LatLng(loc.lat, loc.lng),
                    stopover: true
                };
            });

            const start = ALM_LOCATIONS[stops[0].location];
            const end = ALM_LOCATIONS[stops[stops.length - 1].location];

            const request = {
                origin: new google.maps.LatLng(start.lat, start.lng),
                destination: new google.maps.LatLng(end.lat, end.lng),
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                optimizeWaypoints: false
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Add custom markers for ALM locations
                    addCustomMarkers(stops);
                } else {
                    console.error('Directions request failed:', status);
                    showToast('Failed to load route preview', 'error');
                }
            });
        }

        function addCustomMarkers(stops) {
            stops.forEach((stop, index) => {
                const location = ALM_LOCATIONS[stop.location];
                const isHome = location.type === 'home';
                const isCorporate = location.type === 'corporate';
                
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    icon: {
                        url: `data:image/svg+xml,${encodeURIComponent(`
                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="14" fill="${isHome ? '#22c55e' : isCorporate ? '#ef4444' : '#ffa726'}" stroke="white" stroke-width="2"/>
                                <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">
                                    ${isHome ? 'H' : isCorporate ? 'C' : (index + 1)}
                                </text>
                            </svg>
                        `)}`,
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
            });
        }

        function toggleMapPreview() {
            const mapSection = document.getElementById('map-preview');
            const toggleBtn = document.getElementById('map-toggle-btn');
            
            if (mapSection.style.display === 'none' || !mapSection.style.display) {
                previewRoute();
            } else {
                mapSection.style.display = 'none';
                toggleBtn.textContent = 'Show Map';
            }
        }

        // Route Management
        function clearRoute() {
            currentRoute = [];
            document.getElementById('stops-list').innerHTML = '';
            resetDistanceDisplay();
            
            // Hide map preview
            document.getElementById('map-preview').style.display = 'none';
            
            // Reset form
            document.getElementById('trip-purpose').value = '';
            
            // Initialize with default 3-stop route
            initializeDefaultRoute();
            
            clearDraft();
        }

        function saveRoute() {
            const date = document.getElementById('trip-date').value;
            const purpose = document.getElementById('trip-purpose').value;
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (!date || !purpose || validStops.length < 2 || totalDistance === 0) {
                showToast('Please complete all fields and calculate route', 'warning');
                return;
            }
            
            // Check for non-reimbursable routes
            const isNonReimbursable = checkNonReimbursable(validStops);
            
            const routeData = {
                id: Date.now().toString(),
                date: date,
                purpose: purpose,
                stops: validStops.map(stop => ({
                    location: stop.location,
                    name: ALM_LOCATIONS[stop.location].name
                })),
                totalMiles: totalDistance,
                reimbursable: !isNonReimbursable,
                cost: isNonReimbursable ? 0 : (totalDistance * IRS_RATE),
                timestamp: new Date().toISOString(),
                synced: false
            };
            
            // Save to localStorage
            const existingRoutes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            existingRoutes.push(routeData);
            localStorage.setItem('alm_routes', JSON.stringify(existingRoutes));
            
            // Clear form and draft
            clearRoute();
            clearDraft();
            
            showToast(`Trip saved successfully! ${isNonReimbursable ? '(Non-reimbursable)' : ''}`, 'success');
        }

        function checkNonReimbursable(stops) {
            // Home <-> Corporate is non-reimbursable
            if (stops.length === 2) {
                const [start, end] = stops;
                return (start.location === 'home' && end.location === 'corporate') ||
                       (start.location === 'corporate' && end.location === 'home');
            }
            return false;
        }

        // Draft Management
        function saveDraft() {
            const draftData = {
                date: document.getElementById('trip-date').value,
                purpose: document.getElementById('trip-purpose').value,
                route: currentRoute,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('alm_draft_route', JSON.stringify(draftData));
        }

        function checkDraft() {
            const draft = localStorage.getItem('alm_draft_route');
            if (draft) {
                const draftData = JSON.parse(draft);
                document.getElementById('draft-banner').classList.add('show');
            }
        }

        function resumeDraft() {
            const draft = localStorage.getItem('alm_draft_route');
            if (draft) {
                const draftData = JSON.parse(draft);
                
                // Restore form data
                document.getElementById('trip-date').value = draftData.date || '';
                document.getElementById('trip-purpose').value = draftData.purpose || '';
                
                // Restore route
                if (draftData.route && draftData.route.length > 0) {
                    currentRoute = draftData.route;
                    rebuildStopsList();
                    calculateRoute();
                }
                
                document.getElementById('draft-banner').classList.remove('show');
                showToast('Draft restored successfully', 'success');
            }
        }

        function discardDraft() {
            clearDraft();
            document.getElementById('draft-banner').classList.remove('show');
            showToast('Draft discarded', 'warning');
        }

        function clearDraft() {
            localStorage.removeItem('alm_draft_route');
        }

        function rebuildStopsList() {
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '';
            
            currentRoute.forEach((stop, index) => {
                const stopItem = document.createElement('div');
                stopItem.className = 'stop-item';
                stopItem.dataset.index = index;
                
                let indicatorClass, labelText;
                if (index === 0) {
                    indicatorClass = 'start';
                    labelText = 'START';
                } else if (index === currentRoute.length - 1) {
                    indicatorClass = 'end';
                    labelText = `STOP ${index} - END`;
                } else {
                    indicatorClass = 'middle';
                    labelText = `STOP ${index}`;
                }
                
                stopItem.innerHTML = `
                    <div class="stop-indicator ${indicatorClass}"></div>
                    <div class="stop-label">${labelText}</div>
                    <select class="stop-select" onchange="updateRoute(${index})">
                        <option value="">Choose location...</option>
                        ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                            `<option value="${key}" ${stop.location === key ? 'selected' : ''}>${loc.name}</option>`
                        ).join('')}
                    </select>
                    <div class="stop-distance" style="display: none;">0 mi</div>
                    ${index > 0 ? `<button class="stop-remove" onclick="removeStop(${index})">√ó</button>` : ''}
                `;
                
                stopsList.appendChild(stopItem);
            });
            
            updateStopCounter();
            updateAddStopButton();
        }

        // Status Management
        function updateStatus() {
            updateMapsStatus('checking');
            updateSheetsStatus('checking');
            
            // Check Maps API
            if (typeof google !== 'undefined' && google.maps) {
                updateMapsStatus('connected');
            } else {
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.maps) {
                        updateMapsStatus('connected');
                    } else {
                        updateMapsStatus('disconnected');
                    }
                }, 3000);
            }
            
            // Check Sheets (placeholder for now)
            setTimeout(() => {
                updateSheetsStatus('disconnected');
            }, 1000);
        }

        function updateMapsStatus(status) {
            const pill = document.getElementById('maps-status');
            if (status === 'connected') {
                pill.className = 'status-pill maps-active';
                pill.innerHTML = '‚óè MAPS ACTIVE';
            } else {
                pill.className = 'status-pill sheets-signin'; // red color
                pill.innerHTML = '‚óè MAPS ERROR';
            }
        }

        function updateSheetsStatus(status) {
            const pill = document.getElementById('sheets-status');
            if (status === 'connected') {
                pill.className = 'status-pill maps-active'; // green color
                pill.innerHTML = '‚óè SHEETS CONNECTED';
            } else {
                pill.className = 'status-pill sheets-signin';
                pill.innerHTML = '‚óè SHEETS: SIGN IN';
            }
        }

        // Utility Functions
        function refreshDistances() {
            showToast('Refreshing distance cache...', 'warning');
            // This would clear the distance cache and recalculate
            localStorage.removeItem('maps_distances_v2');
            showToast('Distance cache cleared', 'success');
        }

        function downloadExcel() {
            showToast('Excel download functionality will be available soon', 'warning');
            // This would trigger the Excel export
        }

        function importExcel() {
            showToast('Excel import functionality will be available soon', 'warning');
            // This would trigger the Excel import dialog
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Handle Google Maps API load error
        window.gm_authFailure = function() {
            updateMapsStatus('disconnected');
            showToast('Google Maps authentication failed', 'error');
        };
    </script>
</body>
</html>