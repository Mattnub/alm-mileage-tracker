<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ALM Mileage Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Google Identity Services for OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg:#0a0a0a; --surface:#111111; --surface2:#1a1a1a; --surface3:#222222; --border:#2a2a2a;
    --amber:#f5a623; --amber-dim:#7a5210; --amber-glow:rgba(245,166,35,0.12);
    --red:#e53935; --red-dim:rgba(229,57,53,0.15);
    --green:#4caf50; --green-dim:rgba(76,175,80,0.15);
    --blue:#2196f3; --blue-dim:rgba(33,150,243,0.15);
    --text:#e8e8e8; --text-dim:#666; --text-mid:#999;
    --mono:'IBM Plex Mono',monospace; --sans:'IBM Plex Sans',sans-serif; --display:'Bebas Neue',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);pointer-events:none;z-index:9999;}

  header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 32px;display:flex;align-items:center;justify-content:space-between;height:64px;position:sticky;top:0;z-index:100;}
  .logo{display:flex;align-items:baseline;gap:10px;}
  .logo-mark{font-family:var(--display);font-size:28px;letter-spacing:3px;color:var(--amber);line-height:1;}
  .logo-sub{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
  .header-right{display:flex;align-items:center;gap:10px;}

  .status-pill{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:6px 12px;cursor:pointer;transition:all 0.2s;}
  .status-pill:hover{border-color:var(--amber);}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--red);transition:background 0.3s;flex-shrink:0;}
  .status-dot.active{background:var(--green);box-shadow:0 0 6px var(--green);}
  .status-dot.syncing{background:var(--amber);animation:pulse 1s infinite;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
  .status-label{font-family:var(--mono);font-size:11px;color:var(--text-mid);letter-spacing:1px;}
  .total-badge{font-family:var(--mono);font-size:12px;color:var(--amber);background:var(--amber-glow);border:1px solid var(--amber-dim);padding:6px 14px;border-radius:4px;letter-spacing:1px;}

  .app{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 64px);}
  nav{background:var(--surface);border-right:1px solid var(--border);padding:24px 0;position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;}
  .nav-section{padding:0 16px;margin-bottom:8px;}
  .nav-section-label{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:2px;padding:12px 8px 6px;text-transform:uppercase;}
  .nav-btn{width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;border:none;background:none;color:var(--text-mid);font-family:var(--sans);font-size:13px;cursor:pointer;border-radius:4px;text-align:left;transition:all 0.15s;}
  .nav-btn:hover{background:var(--surface2);color:var(--text);}
  .nav-btn.active{background:var(--amber-glow);color:var(--amber);border-left:2px solid var(--amber);padding-left:10px;}
  .nav-icon{font-size:16px;width:20px;text-align:center;}
  .nav-divider{height:1px;background:var(--border);margin:12px 16px;}
  .stat-mini{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:12px;margin-bottom:8px;}
  .stat-mini-label{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
  .stat-mini-value{font-family:var(--display);font-size:28px;color:var(--amber);letter-spacing:1px;line-height:1.2;}
  .stat-mini-unit{font-family:var(--mono);font-size:10px;color:var(--text-dim);}

  main{padding:32px;overflow-y:auto;}
  .page{display:none;}.page.active{display:block;}
  .page-header{margin-bottom:28px;border-bottom:1px solid var(--border);padding-bottom:20px;}
  .page-title{font-family:var(--display);font-size:42px;color:var(--text);letter-spacing:3px;line-height:1;}
  .page-subtitle{font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:2px;margin-top:6px;}

  .card{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:24px;margin-bottom:20px;}
  .card-title{font-family:var(--mono);font-size:11px;color:var(--amber);letter-spacing:2px;text-transform:uppercase;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
  .card-title::before{content:'';width:3px;height:14px;background:var(--amber);border-radius:2px;}

  .route-meta{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}
  .form-group{display:flex;flex-direction:column;gap:6px;}
  label{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;}
  input,select{background:var(--surface2);border:1px solid var(--border);border-radius:4px;color:var(--text);font-family:var(--mono);font-size:13px;padding:10px 12px;width:100%;outline:none;transition:border-color 0.2s;appearance:none;}
  input:focus,select:focus{border-color:var(--amber);}
  input::placeholder{color:var(--text-dim);}
  select option{background:var(--surface2);}

  .stop-list{display:flex;flex-direction:column;gap:0;}
  .stop-row{display:flex;align-items:stretch;gap:0;position:relative;}
  .stop-connector{display:flex;flex-direction:column;align-items:center;width:40px;flex-shrink:0;}
  .stop-dot{width:12px;height:12px;border-radius:50%;background:var(--amber);border:2px solid var(--bg);z-index:1;flex-shrink:0;margin-top:14px;}
  .stop-dot.home-dot{background:var(--green);}
  .stop-dot.end-dot{background:var(--red);}
  .stop-line{width:2px;background:var(--border);flex:1;margin:0 auto;}
  .stop-line.hidden{background:transparent;}
  .stop-body{flex:1;padding:8px 0 8px 12px;min-width:0;}
  .stop-card{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:14px 16px;display:flex;align-items:center;gap:12px;transition:border-color 0.2s;}
  .stop-label{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:4px;}
  .stop-select-wrap{flex:1;}
  .stop-select-wrap select{background:transparent;border:none;padding:0;font-size:13px;color:var(--text);cursor:pointer;width:100%;}
  .stop-select-wrap select:focus{outline:none;border:none;}
  .leg-badge{font-family:var(--mono);font-size:11px;font-weight:600;color:var(--amber);background:var(--amber-glow);border:1px solid var(--amber-dim);padding:3px 10px;border-radius:4px;white-space:nowrap;min-width:72px;text-align:center;}
  .leg-badge.loading{color:var(--text-dim);background:var(--surface3);border-color:var(--border);}
  .leg-badge.excluded{color:var(--red);background:var(--red-dim);border-color:var(--red);}
  .remove-stop{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:18px;padding:0 4px;line-height:1;transition:color 0.15s;flex-shrink:0;}
  .remove-stop:hover{color:var(--red);}

  .add-stop-row{display:flex;align-items:center;gap:12px;padding:6px 0 6px 52px;}
  .add-stop-btn{font-family:var(--mono);font-size:11px;letter-spacing:1px;padding:7px 16px;border:1px dashed var(--border);border-radius:4px;background:none;color:var(--text-dim);cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:6px;}
  .add-stop-btn:hover:not(:disabled){border-color:var(--amber);color:var(--amber);}
  .add-stop-btn:disabled{opacity:0.3;cursor:not-allowed;}

  .day-total-bar{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:16px 20px;display:flex;align-items:center;gap:20px;margin-top:16px;}
  .day-total-label{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;}
  .day-total-value{font-family:var(--display);font-size:40px;color:var(--amber);letter-spacing:2px;line-height:1;}
  .day-total-unit{font-family:var(--mono);font-size:11px;color:var(--text-dim);}
  .day-total-breakdown{margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--text-mid);line-height:1.8;text-align:right;}

  .btn{font-family:var(--mono);font-size:12px;letter-spacing:1.5px;text-transform:uppercase;padding:11px 20px;border:1px solid;border-radius:4px;cursor:pointer;transition:all 0.15s;}
  .btn-primary{background:var(--amber);border-color:var(--amber);color:#000;font-weight:600;}
  .btn-primary:hover{background:#ffb836;box-shadow:0 0 16px rgba(245,166,35,0.3);}
  .btn-primary:disabled{opacity:0.4;cursor:not-allowed;}
  .btn-ghost{background:transparent;border-color:var(--border);color:var(--text-mid);}
  .btn-ghost:hover{border-color:var(--amber);color:var(--amber);}
  .btn-sheets{background:var(--blue-dim);border-color:var(--blue);color:var(--blue);}
  .btn-sheets:hover{background:rgba(33,150,243,0.25);}
  .btn-row{display:flex;gap:10px;margin-top:18px;justify-content:flex-end;}

  .trip-table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;}
  .trip-table th{text-align:left;padding:8px 12px;color:var(--text-dim);letter-spacing:1.5px;font-size:10px;border-bottom:1px solid var(--border);text-transform:uppercase;font-weight:500;}
  .trip-table td{padding:10px 12px;border-bottom:1px solid rgba(42,42,42,0.5);color:var(--text);vertical-align:middle;}
  .trip-table tr:last-child td{border-bottom:none;}
  .trip-table tr:hover td{background:var(--surface2);}
  .trip-miles{color:var(--amber);font-weight:600;font-size:14px;}
  .delete-btn{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;padding:2px 6px;border-radius:3px;transition:all 0.15s;}
  .delete-btn:hover{color:var(--red);background:var(--red-dim);}
  .purpose-tag{display:inline-block;background:var(--surface3);border-radius:3px;padding:2px 6px;font-size:10px;color:var(--text-dim);letter-spacing:0.5px;}
  .sheets-badge{display:inline-flex;align-items:center;gap:4px;background:var(--blue-dim);border:1px solid rgba(33,150,243,0.3);border-radius:3px;padding:2px 6px;font-size:9px;color:var(--blue);letter-spacing:0.5px;}

  .route-chain{display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
  .route-stop{color:var(--text);}
  .route-arrow{color:var(--amber);font-size:10px;}
  .expand-row{display:none;background:var(--surface2);}
  .expand-row td{padding:10px 12px 14px 28px;}
  .leg-detail{font-family:var(--mono);font-size:11px;color:var(--text-mid);display:flex;flex-direction:column;gap:4px;}
  .leg-detail-row{display:flex;align-items:center;gap:8px;}
  .leg-detail-mi{color:var(--amber);min-width:50px;}

  .matrix-wrapper{overflow-x:auto;margin-top:8px;}
  .matrix-table{border-collapse:collapse;font-family:var(--mono);font-size:11px;min-width:100%;}
  .matrix-table th{padding:8px 10px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);font-size:10px;letter-spacing:1px;white-space:nowrap;font-weight:500;}
  .matrix-table th.row-header{text-align:left;min-width:140px;position:sticky;left:0;z-index:1;}
  .matrix-table td{border:1px solid var(--border);text-align:center;padding:6px 8px;white-space:nowrap;min-width:70px;position:relative;transition:filter 0.15s;}
  .matrix-table td:hover{filter:brightness(1.3);}
  .matrix-table td.self{background:var(--surface3);color:var(--text-dim);}
  .matrix-table td.excluded{background:repeating-linear-gradient(45deg,rgba(229,57,53,0.05),rgba(229,57,53,0.05) 4px,transparent 4px,transparent 8px);color:var(--red);font-size:10px;letter-spacing:1px;}
  .matrix-table td.green{background:rgba(76,175,80,0.12);color:#81c784;}
  .matrix-table td.yellow{background:rgba(255,193,7,0.1);color:#ffd54f;}
  .matrix-table td.orange{background:rgba(255,152,0,0.12);color:#ffb74d;}
  .matrix-table td.red-cell{background:rgba(229,57,53,0.1);color:#e57373;}
  .cell-miles{font-size:12px;font-weight:600;}.cell-unit{font-size:9px;color:var(--text-dim);}
  .source-dot{position:absolute;top:3px;right:3px;width:5px;height:5px;border-radius:50%;}
  .source-dot.live{background:var(--green);}.source-dot.estimated{background:var(--text-dim);}

  .legend{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:16px;}
  .legend-item{display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:10px;color:var(--text-dim);}
  .legend-swatch{width:12px;height:12px;border-radius:2px;}

  .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:16px;}
  .stat-label{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
  .stat-value{font-family:var(--display);font-size:36px;color:var(--amber);letter-spacing:1px;line-height:1;}
  .stat-unit{font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-top:2px;}

  .filter-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;}
  .filter-chip{font-family:var(--mono);font-size:10px;letter-spacing:1px;padding:5px 12px;border:1px solid var(--border);border-radius:20px;background:none;color:var(--text-dim);cursor:pointer;transition:all 0.15s;}
  .filter-chip.active,.filter-chip:hover{border-color:var(--amber);color:var(--amber);background:var(--amber-glow);}

  .empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);}
  .empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3;}
  .empty-text{font-family:var(--mono);font-size:12px;letter-spacing:1px;}

  .refresh-section{display:flex;align-items:center;gap:16px;margin-bottom:16px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:16px;}
  .refresh-info{flex:1;font-family:var(--mono);font-size:11px;color:var(--text-mid);line-height:1.5;}
  .progress-bar{height:3px;background:var(--surface3);border-radius:2px;margin-top:8px;overflow:hidden;display:none;}
  .progress-fill{height:100%;background:var(--amber);border-radius:2px;transition:width 0.3s;width:0;}

  /* Sheets connect card */
  .sheets-connect{background:var(--surface2);border:1px solid rgba(33,150,243,0.3);border-radius:6px;padding:20px;display:flex;align-items:center;gap:16px;margin-bottom:20px;}
  .sheets-icon{font-size:28px;flex-shrink:0;}
  .sheets-info{flex:1;}
  .sheets-info-title{font-family:var(--mono);font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;}
  .sheets-info-sub{font-family:var(--mono);font-size:10px;color:var(--text-dim);line-height:1.5;}

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px);}
  .modal-overlay.open{display:flex;}
  .modal{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:32px;max-width:520px;width:90%;}
  .modal-title{font-family:var(--display);font-size:32px;letter-spacing:3px;color:var(--text);margin-bottom:6px;}
  .modal-sub{font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:20px;line-height:1.6;}
  .modal-btn-row{display:flex;gap:10px;margin-top:16px;justify-content:flex-end;}

  .toast-container{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:8px;}
  .toast{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:12px 16px;font-family:var(--mono);font-size:12px;color:var(--text);min-width:280px;display:flex;align-items:center;gap:10px;animation:slideIn 0.2s ease;box-shadow:0 4px 20px rgba(0,0,0,0.4);}
  .toast.success{border-color:var(--green);}.toast.error{border-color:var(--red);}.toast.info{border-color:var(--amber);}.toast.sheets{border-color:var(--blue);}
  @keyframes slideIn{from{transform:translateX(20px);opacity:0;}to{transform:translateX(0);opacity:1;}}

  /* CHANGELOG */
  .changelog-entry{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:24px;margin-bottom:16px;display:grid;grid-template-columns:80px 1fr;gap:0;}
  .changelog-entry.current{border-color:var(--amber);}
  .cl-version-col{display:flex;flex-direction:column;align-items:flex-start;padding-right:24px;border-right:1px solid var(--border);}
  .cl-version{font-family:var(--display);font-size:36px;color:var(--amber);letter-spacing:2px;line-height:1;}
  .cl-current-badge{font-family:var(--mono);font-size:9px;letter-spacing:1px;background:var(--amber-glow);border:1px solid var(--amber-dim);color:var(--amber);padding:2px 6px;border-radius:3px;margin-top:6px;white-space:nowrap;}
  .cl-body{padding-left:24px;}
  .cl-title{font-family:var(--mono);font-size:13px;color:var(--text);font-weight:600;margin-bottom:4px;letter-spacing:0.5px;}
  .cl-date{font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;margin-bottom:12px;}
  .cl-changes{list-style:none;display:flex;flex-direction:column;gap:6px;}
  .cl-change{display:flex;gap:10px;font-family:var(--mono);font-size:11px;color:var(--text-mid);line-height:1.5;}
  .cl-bullet{color:var(--amber);flex-shrink:0;}

  ::-webkit-scrollbar{width:6px;height:6px;}::-webkit-scrollbar-track{background:var(--surface);}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  .miles-spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--amber);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<!-- GOOGLE SIGN-IN MODAL -->
<div class="modal-overlay" id="sheetsModal">
  <div class="modal">
    <div class="modal-title">SYNC TO SHEETS</div>
    <div class="modal-sub">Sign in with your Google account to enable automatic backup of every route to your Google Sheet. You'll only need to do this once.</div>
    <div style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:14px 16px;margin-bottom:20px;font-family:var(--mono);font-size:11px;color:var(--text-mid);line-height:1.8;">
      <span style="color:var(--amber)">→</span> Sheet: <strong style="color:var(--text)">ALM Mileage Tracker</strong><br>
      <span style="color:var(--amber)">→</span> Syncs automatically on every Save Route<br>
      <span style="color:var(--amber)">→</span> Writes to: Summary tab + Detailed Legs tab
    </div>
    <div id="googleSignInBtn" style="display:flex;justify-content:center;margin-bottom:8px;"></div>
    <div class="modal-btn-row">
      <button class="btn btn-ghost" onclick="closeSheetsModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<header>
  <div class="logo"><span class="logo-mark">ALM</span><span class="logo-sub">Mileage Tracker</span><span style="font-family:var(--mono);font-size:9px;color:var(--amber-dim);letter-spacing:1px;margin-left:4px;align-self:flex-end;padding-bottom:2px">v4</span></div>
  <div class="header-right">
    <!-- Maps status -->
    <div class="status-pill" title="Google Maps Distance API">
      <div class="status-dot active" id="mapsStatus"></div>
      <span class="status-label">MAPS ACTIVE</span>
    </div>
    <!-- Sheets status -->
    <div class="status-pill" onclick="openSheetsModal()" id="sheetsPill">
      <div class="status-dot" id="sheetsStatus"></div>
      <span class="status-label" id="sheetsLabel">SHEETS: SIGN IN</span>
    </div>
    <div class="total-badge" id="headerTotal">0.0 MI TOTAL</div>
  </div>
</header>

<div class="app">
  <nav>
    <div class="nav-section">
      <div class="nav-section-label">Log</div>
      <button class="nav-btn active" onclick="showPage('newTrip',this)"><span class="nav-icon">＋</span> New Route</button>
      <button class="nav-btn" onclick="showPage('history',this)"><span class="nav-icon">◷</span> Trip History</button>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-section-label">Data</div>
      <button class="nav-btn" onclick="showPage('locations',this)"><span class="nav-icon">◎</span> Locations</button>
      <button class="nav-btn" onclick="showPage('matrix',this)"><span class="nav-icon">⊞</span> Distance Matrix</button>
      <button class="nav-btn" onclick="showPage('refresh',this)"><span class="nav-icon">↺</span> Refresh Distances</button>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-section-label">Export</div>
      <button class="nav-btn" onclick="downloadExcel()"><span class="nav-icon">↓</span> Download Excel</button>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-section-label">App</div>
      <button class="nav-btn" onclick="showPage('changelog',this)"><span class="nav-icon">◈</span> Changelog</button>
    </div>
    <div class="nav-divider"></div>
    <div style="padding:8px 16px;margin-top:8px">
      <div class="stat-mini"><div class="stat-mini-label">Total Miles</div><div class="stat-mini-value" id="sidebarTotal">0.0</div><div class="stat-mini-unit">miles logged</div></div>
      <div class="stat-mini"><div class="stat-mini-label">Days Logged</div><div class="stat-mini-value" id="sidebarCount">0</div><div class="stat-mini-unit">route days</div></div>
    </div>
  </nav>

  <main>

    <!-- NEW ROUTE PAGE -->
    <div class="page active" id="page-newTrip">
      <div class="page-header">
        <div class="page-title">NEW ROUTE</div>
        <div class="page-subtitle">BUILD YOUR DAY'S STOPS — UP TO 6 LOCATIONS</div>
      </div>
      <div class="card">
        <div class="card-title">Route Details</div>
        <div class="route-meta">
          <div class="form-group"><label>Date</label><input type="date" id="routeDate"/></div>
          <div class="form-group"><label>Purpose</label>
            <select id="routePurpose">
              <option>Dealership Visits</option><option>Customer Meetings</option>
              <option>Parts Pickup</option><option>Training</option>
              <option>Mixed</option><option>Other</option>
            </select>
          </div>
        </div>
        <div class="stop-list" id="stopList"></div>
        <div class="add-stop-row">
          <button class="add-stop-btn" id="addStopBtn" onclick="addStop()"><span>＋</span> Add Stop</button>
          <span id="stopCounter" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;"></span>
        </div>
        <div class="day-total-bar">
          <div>
            <div class="day-total-label">Day Total</div>
            <div style="display:flex;align-items:baseline;gap:8px">
              <span class="day-total-value" id="dayTotalValue">0.0</span>
              <span class="day-total-unit">miles</span>
            </div>
          </div>
          <div class="day-total-breakdown" id="dayBreakdown"></div>
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost" onclick="clearRoute()">Clear</button>
          <button class="btn btn-primary" id="saveRouteBtn" onclick="saveRoute()" disabled>Save Route</button>
        </div>
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div class="page" id="page-history">
      <div class="page-header">
        <div class="page-title">TRIP HISTORY</div>
        <div class="page-subtitle">ALL LOGGED ROUTE DAYS</div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Miles</div><div class="stat-value" id="statTotal">0.0</div><div class="stat-unit">miles</div></div>
        <div class="stat-card"><div class="stat-label">Route Days</div><div class="stat-value" id="statDays">0</div><div class="stat-unit">days</div></div>
        <div class="stat-card"><div class="stat-label">Avg Per Day</div><div class="stat-value" id="statAvg">0.0</div><div class="stat-unit">miles</div></div>
        <div class="stat-card"><div class="stat-label">This Month</div><div class="stat-value" id="statMonth">0.0</div><div class="stat-unit">miles</div></div>
      </div>
      <div class="card">
        <div class="card-title">All Route Days</div>
        <div class="filter-row" id="monthFilters"><button class="filter-chip active" onclick="filterMonth('all',this)">All</button></div>
        <table class="trip-table">
          <thead><tr><th>Date</th><th>Route</th><th>Legs</th><th>Miles</th><th>Purpose</th><th>Synced</th><th></th></tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <!-- LOCATIONS PAGE -->
    <div class="page" id="page-locations">
      <div class="page-header">
        <div class="page-title">LOCATIONS</div>
        <div class="page-subtitle">ALL STORED ALM LOCATIONS &amp; ADDRESSES</div>
      </div>
      <div class="card" style="padding:0;overflow:hidden">
        <table class="trip-table">
          <thead><tr>
            <th style="padding:14px 20px;width:24px">#</th>
            <th style="padding:14px 20px">Name</th>
            <th style="padding:14px 20px">Address</th>
            <th style="padding:14px 20px">Notes</th>
          </tr></thead>
          <tbody id="locationsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- MATRIX PAGE -->
    <div class="page" id="page-matrix">
      <div class="page-header">
        <div class="page-title">DISTANCE MATRIX</div>
        <div class="page-subtitle">ALL ROUTE DISTANCES BETWEEN ALM LOCATIONS</div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(76,175,80,0.3)"></div> &lt;20 mi</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,193,7,0.2)"></div> 20–35 mi</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(255,152,0,0.25)"></div> 35–55 mi</div>
        <div class="legend-item"><div class="legend-swatch" style="background:rgba(229,57,53,0.2)"></div> 55+ mi</div>
        <div class="legend-item"><div class="legend-swatch" style="background:repeating-linear-gradient(45deg,rgba(229,57,53,0.1),rgba(229,57,53,0.1) 3px,transparent 3px,transparent 6px)"></div> Not Reimbursed</div>
        <div class="legend-item" style="margin-left:auto"><div class="source-dot live" style="position:static;width:8px;height:8px;border-radius:50%"></div> Live Maps</div>
        <div class="legend-item"><div class="source-dot estimated" style="position:static;width:8px;height:8px;border-radius:50%"></div> Estimated</div>
      </div>
      <div class="card" style="padding:16px"><div class="matrix-wrapper" id="matrixWrapper"></div></div>
    </div>

    <!-- REFRESH PAGE -->
    <div class="page" id="page-refresh">
      <div class="page-header">
        <div class="page-title">REFRESH DISTANCES</div>
        <div class="page-subtitle">PULL LIVE DRIVING DISTANCES FROM GOOGLE MAPS</div>
      </div>
      <div class="card">
        <div class="card-title">Google Maps Sync</div>
        <div class="refresh-section">
          <div class="refresh-info">
            <span id="refreshStatus">Click Refresh All to pull real driving distances from Google Maps Distance Matrix API.</span>
            <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
          </div>
          <button class="btn btn-primary" id="refreshBtn" onclick="refreshAllDistances()">↺ Refresh All</button>
        </div>
        <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);line-height:1.8;margin-top:8px">
          <strong style="color:var(--text)">Locations:</strong><br>
          <span id="locationList" style="color:var(--amber)"></span>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Excluded Routes</div>
        <div style="font-family:var(--mono);font-size:12px;color:var(--text-mid);line-height:2">
          The following routes are <strong style="color:var(--red)">not reimbursable</strong> and excluded from all calculations:<br><br>
          <span style="color:var(--red)">✗</span> Home → ALM Corporate (Norcross)<br>
          <span style="color:var(--red)">✗</span> ALM Corporate (Norcross) → Home
        </div>
      </div>
    </div>

    <!-- CHANGELOG PAGE -->
    <div class="page" id="page-changelog">
      <div class="page-header">
        <div class="page-title">CHANGELOG</div>
        <div class="page-subtitle">VERSION HISTORY &amp; RELEASE NOTES</div>
      </div>
      <div id="changelogList"></div>
    </div>

  </main>
</div>

<script>
// ── CONFIG ────────────────────────────────────────────────────────────────
const MAPS_API_KEY   = 'AIzaSyBjlBfZykUSXuKi-O3OGJ4YTfiI4H3CpdE';
const OAUTH_CLIENT_ID = '609546008185-ujeh6euqkncujt6fnkfhl75g717th2vf.apps.googleusercontent.com';
const SHEET_ID       = '1IaoW_MkFKrG3TlRZMXNTHxUKmiFjv5f96mS0LyD1gAQ';
const SCOPES         = 'https://www.googleapis.com/auth/spreadsheets';

// ── LOCATIONS ──────────────────────────────────────────────────────────────
const LOCATIONS = [
  { name:"Home",              address:"216 Winterbury Drive, Canton, GA 30114",            coords:[-84.5002,34.2365] },
  { name:"ALM Kennesaw",      address:"2255 Barrett Lakes Blvd NW, Kennesaw, GA 30144",    coords:[-84.6113,34.0234] },
  { name:"ALM Ford Marietta", address:"869 Cobb Pkwy SE, Marietta, GA 30060",             coords:[-84.5524,33.9346] },
  { name:"ALM Marietta",      address:"1071 Cobb Pkwy SE, Marietta, GA 30060",            coords:[-84.5502,33.9198] },
  { name:"ALM Gwinnett",      address:"2520 Pleasant Hill Rd, Duluth, GA 30096",          coords:[-84.1448,33.9756] },
  { name:"ALM Buford",        address:"4228 Buford Dr, Buford, GA 30518",                 coords:[-84.0163,34.1052] },
  { name:"ALM Roswell",       address:"891 Mansell Rd, Roswell, GA 30076",                coords:[-84.3381,34.0428] },
  { name:"ALM Newnan",        address:"40 International Park, Newnan, GA 30265",          coords:[-84.7997,33.3846] },
  { name:"ALM McDonough",     address:"980 Jonesboro Rd, McDonough, GA 30253",            coords:[-84.1469,33.4473] },
  { name:"ALM Corporate",     address:"6625 The Corners Pkwy NW, Norcross, GA 30092",    coords:[-84.2135,33.9408] },
];
const EXCLUDED = new Set(["Home|ALM Corporate","ALM Corporate|Home"]);
const MAX_STOPS = 6;

// Haversine fallback estimates
const ESTIMATES = {};
function haversine(c1,c2){
  const R=3958.8,dLat=(c2[1]-c1[1])*Math.PI/180,dLon=(c2[0]-c1[0])*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(c1[1]*Math.PI/180)*Math.cos(c2[1]*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*1.25;
}
LOCATIONS.forEach((a,i)=>LOCATIONS.forEach((b,j)=>{
  if(i!==j){const k=`${a.name}|${b.name}`;if(!EXCLUDED.has(k))ESTIMATES[k]=+haversine(a.coords,b.coords).toFixed(1);}
}));

// ── STATE ─────────────────────────────────────────────────────────────────
// Cache key for Google Maps Distance Matrix distances
let liveDistances = JSON.parse(localStorage.getItem('maps_distances_v2')||'{}');
let routeDays     = JSON.parse(localStorage.getItem('alm_routes')||'[]');
let currentFilter = 'all';
let stops         = [null, null];
let legMiles      = {};
let legSources    = {};
let accessToken   = localStorage.getItem('google_access_token')||'';
let tokenExpiry   = parseInt(localStorage.getItem('google_token_expiry')||'0');

// ── INIT ──────────────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('routeDate').value = new Date().toISOString().split('T')[0];
  renderStopList();
  renderLocations();
  renderMatrix();
  renderHistory();
  updateGlobalStats();
  document.getElementById('locationList').textContent = LOCATIONS.map(l=>l.name).join(' · ');
  updateSheetsStatus();
  initGoogleSignIn();
});

// ── GOOGLE SIGN-IN ────────────────────────────────────────────────────────
function initGoogleSignIn(){
  if(typeof google === 'undefined') { setTimeout(initGoogleSignIn, 500); return; }
  google.accounts.id.initialize({
    client_id: OAUTH_CLIENT_ID,
    callback: handleCredentialResponse,
  });
  // OAuth2 token client for Sheets write access
  window.tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: OAUTH_CLIENT_ID,
    scope: SCOPES,
    callback: async (resp) => {
      if(resp.error){ toast('Google sign-in failed: '+resp.error,'error'); return; }
      accessToken = resp.access_token;
      tokenExpiry = Date.now() + (resp.expires_in - 60) * 1000;
      localStorage.setItem('google_access_token', accessToken);
      localStorage.setItem('google_token_expiry', String(tokenExpiry));
      updateSheetsStatus();
      closeSheetsModal();
      toast('Connected to Google Sheets!','sheets');
      // Retry any unsynced routes now that we have a token
      const unsynced = routeDays.filter(r=>!r.synced);
      if(unsynced.length){
        toast(`Syncing ${unsynced.length} pending route${unsynced.length>1?'s':''}...`,'info');
        await ensureSheets();
        for(const route of unsynced) await syncRouteToSheets(route);
      }
    },
  });
}

function handleCredentialResponse(response){ /* handled via token client */ }

function openSheetsModal(){
  document.getElementById('sheetsModal').classList.add('open');
  setTimeout(()=>{
    const container = document.getElementById('googleSignInBtn');
    const label = isTokenValid() ? 'Re-authenticate Google' : 'Sign in with Google';
    container.innerHTML = `<button class="btn btn-primary" style="font-size:14px;padding:14px 28px;letter-spacing:1px" onclick="requestSheetsAccess()">${label}</button>`;
  }, 100);
}

function requestSheetsAccess(){
  if(window.tokenClient) window.tokenClient.requestAccessToken({prompt:''});
  else toast('Google API still loading, try again','error');
}

function closeSheetsModal(){ document.getElementById('sheetsModal').classList.remove('open'); }

function isTokenValid(){ return accessToken && Date.now() < tokenExpiry; }

function updateSheetsStatus(){
  const dot   = document.getElementById('sheetsStatus');
  const label = document.getElementById('sheetsLabel');
  const pill  = document.getElementById('sheetsPill');
  if(isTokenValid()){
    dot.classList.add('active');
    label.textContent = 'SHEETS: CONNECTED';
    pill.title = 'Click to re-authenticate';
  } else {
    dot.classList.remove('active');
    label.textContent = 'SHEETS: SIGN IN';
    pill.title = 'Click to connect Google Sheets auto-backup';
  }
}

// ── GOOGLE MAPS DISTANCE ──────────────────────────────────────────────────
async function fetchMapsDistance(from, to){
  const f = LOCATIONS.find(l=>l.name===from);
  const t = LOCATIONS.find(l=>l.name===to);
  if(!f||!t) return null;
  // Distance Matrix API — supports browser CORS, returns actual driving road miles
  const origin = `${f.coords[1]},${f.coords[0]}`;
  const dest   = `${t.coords[1]},${t.coords[0]}`;
  const url = `https://maps.googleapis.com/maps/api/distancematrix/json?origins=${origin}&destinations=${dest}&units=imperial&mode=driving&key=${MAPS_API_KEY}`;
  try {
    const res  = await fetch(url);
    const data = await res.json();
    if(data.status !== 'OK') throw new Error(data.status);
    const el = data.rows[0].elements[0];
    if(el.status !== 'OK') throw new Error(el.status);
    return +(el.distance.value * 0.000621371).toFixed(1);
  } catch(e) {
    console.error('Maps API error:', e);
    return null;
  }
}

// ── STOP BUILDER ──────────────────────────────────────────────────────────
function renderStopList(){
  const list = document.getElementById('stopList');
  list.innerHTML = '';
  stops.forEach((stop, i) => {
    const isFirst = i===0, isLast = i===stops.length-1;
    const canDelete = stops.length > 2 && !isFirst;
    const row = document.createElement('div'); row.className='stop-row';
    const conn = document.createElement('div'); conn.className='stop-connector';
    const dot = document.createElement('div');
    dot.className='stop-dot'+(isFirst?' home-dot':isLast?' end-dot':'');
    conn.appendChild(dot);
    const line = document.createElement('div');
    line.className='stop-line'+(isLast?' hidden':'');
    conn.appendChild(line); row.appendChild(conn);
    const body = document.createElement('div'); body.className='stop-body';
    const label = document.createElement('div'); label.className='stop-label';
    label.textContent = isFirst?'Start':isLast?`Stop ${i} — End`:`Stop ${i}`;
    body.appendChild(label);
    const card = document.createElement('div'); card.className='stop-card';
    const wrap = document.createElement('div'); wrap.className='stop-select-wrap';
    const sel = document.createElement('select');
    sel.innerHTML = `<option value="">Choose location...</option>`+
      LOCATIONS.map(l=>`<option value="${l.name}"${stop===l.name?' selected':''}>${l.name}</option>`).join('');
    sel.onchange=()=>{ stops[i]=sel.value||null; onStopChange(i); };
    wrap.appendChild(sel); card.appendChild(wrap);
    if(!isLast){
      const badge=document.createElement('div');
      badge.id=`leg-badge-${i}`; badge.className='leg-badge loading'; badge.textContent='—';
      card.appendChild(badge);
    }
    if(canDelete){
      const del=document.createElement('button'); del.className='remove-stop';
      del.innerHTML='×'; del.title='Remove stop';
      del.onclick=()=>removeStop(i); card.appendChild(del);
    }
    body.appendChild(card); row.appendChild(body); list.appendChild(row);
  });
  recalcAllLegs();
  const btn=document.getElementById('addStopBtn');
  btn.disabled=stops.length>=MAX_STOPS;
  document.getElementById('stopCounter').textContent=`${stops.length} locations · ${stops.length-1} legs`;
}

function addStop(){ if(stops.length<MAX_STOPS){stops.push(null);renderStopList();} }
function removeStop(i){ stops.splice(i,1); legMiles={}; legSources={}; renderStopList(); }
function clearRoute(){
  stops=[null,null]; legMiles={}; legSources={};
  document.getElementById('routeDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('routePurpose').value='Dealership Visits';
  renderStopList(); updateDayTotal();
}
function onStopChange(i){
  delete legMiles[`${i-1}-${i}`]; delete legSources[`${i-1}-${i}`];
  delete legMiles[`${i}-${i+1}`]; delete legSources[`${i}-${i+1}`];
  recalcAllLegs();
}
async function recalcAllLegs(){
  const promises=[];
  for(let i=0;i<stops.length-1;i++) promises.push(recalcLeg(i,i+1));
  await Promise.all(promises);
  updateDayTotal();
}
async function recalcLeg(fromIdx, toIdx){
  const key=`${fromIdx}-${toIdx}`;
  const from=stops[fromIdx], to=stops[toIdx];
  const badge=document.getElementById(`leg-badge-${fromIdx}`);
  if(!badge) return;
  if(!from||!to){ badge.className='leg-badge loading'; badge.textContent='—'; delete legMiles[key]; return; }
  if(from===to){ badge.className='leg-badge loading'; badge.textContent='same'; delete legMiles[key]; return; }
  const pairKey=`${from}|${to}`;
  if(EXCLUDED.has(pairKey)){ badge.className='leg-badge excluded'; badge.textContent='N/R'; legMiles[key]=0; legSources[key]='excluded'; return; }
  badge.className='leg-badge loading'; badge.innerHTML='<span class="miles-spinner"></span>';
  let miles=null, source='estimated';
  // Check cache first
  if(liveDistances[pairKey]!==undefined){ miles=liveDistances[pairKey]; source='cached'; }
  else {
    // Fetch from Google Maps
    miles = await fetchMapsDistance(from, to);
    if(miles!==null){ liveDistances[pairKey]=miles; localStorage.setItem('maps_distances_v2',JSON.stringify(liveDistances)); source='live'; }
  }
  if(miles===null){ miles=ESTIMATES[pairKey]||null; source='estimated'; }
  if(miles!==null){
    legMiles[key]=miles; legSources[key]=source;
    badge.className='leg-badge';
    badge.textContent=`${miles} mi`;
    badge.title=`${source==='live'?'Live Maps':source==='cached'?'Cached Maps':'Estimated'}: ${from} → ${to}`;
  } else {
    badge.className='leg-badge loading'; badge.textContent='?'; delete legMiles[key];
  }
}
function updateDayTotal(){
  let total=0; const lines=[];
  for(let i=0;i<stops.length-1;i++){
    const key=`${i}-${i+1}`, from=stops[i], to=stops[i+1];
    if(!from||!to) continue;
    const pairKey=`${from}|${to}`;
    if(EXCLUDED.has(pairKey)){ lines.push(`<span style="color:var(--red)">N/R</span>  ${from} → ${to}`); continue; }
    const m=legMiles[key];
    if(m!==undefined){ total+=m; lines.push(`${m} mi  ${from} → ${to}`); }
  }
  document.getElementById('dayTotalValue').textContent=total.toFixed(1);
  document.getElementById('dayBreakdown').innerHTML=lines.join('<br>')||'<span style="color:var(--text-dim)">Add stops to see breakdown</span>';
  document.getElementById('saveRouteBtn').disabled=stops.filter(Boolean).length<2;
}

// ── SAVE ROUTE ────────────────────────────────────────────────────────────
async function saveRoute(){
  const date=document.getElementById('routeDate').value;
  const purpose=document.getElementById('routePurpose').value;
  if(!date){ toast('Please select a date','error'); return; }
  if(stops.filter(Boolean).length<2){ toast('Add at least 2 stops','error'); return; }
  const legs=[]; let totalMiles=0;
  for(let i=0;i<stops.length-1;i++){
    const key=`${i}-${i+1}`, from=stops[i], to=stops[i+1];
    if(!from||!to) continue;
    if(EXCLUDED.has(`${from}|${to}`)) continue;
    const m=legMiles[key];
    if(m===undefined) continue;
    legs.push({from,to,miles:m,source:legSources[key]||'estimated'});
    totalMiles+=m;
  }
  const route={id:Date.now(),date,purpose,legs,totalMiles:+totalMiles.toFixed(1),stops:stops.filter(Boolean),synced:false};
  routeDays.push(route);
  localStorage.setItem('alm_routes',JSON.stringify(routeDays));
  const msg=legs.length===0
    ?`Day logged — 0 reimbursable miles (Home ↔ Corporate only)`
    :`Route saved — ${route.totalMiles} mi across ${legs.length} leg${legs.length>1?'s':''}`;
  toast(msg,'success');
  clearRoute(); renderHistory(); updateGlobalStats();
  // Auto-sync to Sheets
  await syncRouteToSheets(route);
}

// ── GOOGLE SHEETS SYNC ────────────────────────────────────────────────────
async function syncRouteToSheets(route){
  // If token expired or missing, prompt re-auth and skip
  if(!isTokenValid()){
    updateSheetsStatus();
    return;
  }
  updateSheetsSyncing(true);
  try {
    await ensureSheets();
    // Summary row
    const summaryRow = [[route.date, route.totalMiles, route.legs.length, route.purpose, route.stops.join(' → ')]];
    await sheetsAppend('Summary', 'A:E', summaryRow);
    // Leg rows
    if(route.legs.length > 0){
      const legRows = route.legs.map(l=>[route.date, l.from, l.to, l.miles, l.source, route.purpose]);
      await sheetsAppend('Detailed Legs', 'A:F', legRows);
    } else {
      await sheetsAppend('Detailed Legs', 'A:F', [[route.date, route.stops[0], route.stops[route.stops.length-1], 0, 'N/R', route.purpose]]);
    }
    routeDays = routeDays.map(r=>r.id===route.id?{...r,synced:true}:r);
    localStorage.setItem('alm_routes',JSON.stringify(routeDays));
    renderHistory();
    toast('Synced to Google Sheets ✓','sheets');
  } catch(e){
    console.error('Sheets sync error:', e);
    // Show the actual error message so we can debug
    const msg = e.message || String(e);
    toast('Sheets sync failed: ' + msg.slice(0,80), 'error');
  }
  updateSheetsSyncing(false);
}

function updateSheetsSyncing(syncing){
  const dot=document.getElementById('sheetsStatus');
  if(syncing){ dot.classList.remove('active'); dot.classList.add('syncing'); }
  else{ dot.classList.remove('syncing'); if(isTokenValid()) dot.classList.add('active'); }
}

async function ensureSheets(){
  const res = await fetch(
    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?fields=sheets.properties.title`,
    { headers:{ Authorization:`Bearer ${accessToken}` } }
  );
  if(!res.ok){ const e=await res.json(); throw new Error('getSpreadsheet: '+(e.error?.message||res.status)); }
  const data = await res.json();
  const existing = (data.sheets||[]).map(s=>s.properties.title);

  const toAdd = [];
  if(!existing.includes('Summary'))       toAdd.push('Summary');
  if(!existing.includes('Detailed Legs')) toAdd.push('Detailed Legs');

  if(toAdd.length){
    const batchRes = await fetch(
      `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}:batchUpdate`,
      { method:'POST',
        headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' },
        body: JSON.stringify({ requests: toAdd.map(t=>({ addSheet:{ properties:{ title:t } } })) })
      }
    );
    if(!batchRes.ok){ const e=await batchRes.json(); throw new Error('addSheet: '+(e.error?.message||batchRes.status)); }
    // Write headers into new tabs
    if(toAdd.includes('Summary'))
      await sheetsUpdate('Summary', 'A1:E1', [['Date','Total Miles','Legs','Purpose','Route']]);
    if(toAdd.includes('Detailed Legs'))
      await sheetsUpdate('Detailed Legs', 'A1:F1', [['Date','From','To','Miles','Source','Purpose']]);
  }
}

// Encode only the sheet name (handles spaces), leave range notation (A:F) unencoded
async function sheetsAppend(sheet, range, values){
  const encodedRange = `${encodeURIComponent(sheet)}!${range}`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodedRange}:append?valueInputOption=USER_ENTERED&insertDataOption=INSERT_ROWS`;
  const res = await fetch(url, {
    method:'POST',
    headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' },
    body: JSON.stringify({values})
  });
  if(!res.ok){ const e=await res.json(); throw new Error('append '+sheet+': '+(e.error?.message||res.status)); }
  return res.json();
}

async function sheetsUpdate(sheet, range, values){
  const encodedRange = `${encodeURIComponent(sheet)}!${range}`;
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodedRange}?valueInputOption=USER_ENTERED`;
  const res = await fetch(url, {
    method:'PUT',
    headers:{ Authorization:`Bearer ${accessToken}`, 'Content-Type':'application/json' },
    body: JSON.stringify({values})
  });
  if(!res.ok){ const e=await res.json(); throw new Error('update '+sheet+': '+(e.error?.message||res.status)); }
  return res.json();
}

// Manual sync all unsynced routes
async function syncAllUnsynced(){
  if(!isTokenValid()){ openSheetsModal(); return; }
  const unsynced = routeDays.filter(r=>!r.synced);
  if(!unsynced.length){ toast('All routes already synced','info'); return; }
  toast(`Syncing ${unsynced.length} unsynced route${unsynced.length>1?'s':''}...`,'info');
  await ensureSheets();
  for(const route of unsynced) await syncRouteToSheets(route);
  toast(`Sync complete!`,'sheets');
}

// ── HISTORY ───────────────────────────────────────────────────────────────
function renderHistory(){
  const body=document.getElementById('historyBody');
  let filtered=currentFilter==='all'?routeDays:routeDays.filter(r=>r.date.startsWith(currentFilter));
  if(!filtered.length){
    body.innerHTML=`<tr><td colspan="7"><div class="empty-state"><div class="empty-icon">◫</div><div class="empty-text">No routes logged yet</div></div></td></tr>`;
    return;
  }
  const sorted=[...filtered].sort((a,b)=>b.date.localeCompare(a.date));
  body.innerHTML=sorted.map(r=>{
    const chain=r.stops.map((s,i)=>i<r.stops.length-1
      ?`<span class="route-stop">${s}</span><span class="route-arrow">→</span>`
      :`<span class="route-stop">${s}</span>`).join('');
    const legRows=r.legs.map(l=>`<div class="leg-detail-row"><span class="leg-detail-mi">${l.miles} mi</span><span>${l.from} → ${l.to}</span></div>`).join('');
    const legsCell=r.legs.length===0?'<span style="color:var(--red);font-size:10px">N/R only</span>':r.legs.length+' leg'+(r.legs.length>1?'s':'');
    const syncedCell=r.synced?'<span class="sheets-badge">⬆ Sheets</span>':'<span style="color:var(--text-dim);font-size:10px">local</span>';
    return `
      <tr onclick="toggleExpand(${r.id})" style="cursor:pointer">
        <td style="color:var(--text-dim);white-space:nowrap">${fmtDate(r.date)}</td>
        <td><div class="route-chain">${chain}</div></td>
        <td style="color:var(--text-mid)">${legsCell}</td>
        <td class="trip-miles">${r.totalMiles}</td>
        <td><span class="purpose-tag">${r.purpose}</span></td>
        <td>${syncedCell}</td>
        <td><button class="delete-btn" onclick="event.stopPropagation();deleteRoute(${r.id})">×</button></td>
      </tr>
      <tr class="expand-row" id="expand-${r.id}">
        <td colspan="7"><div class="leg-detail">${legRows||'<span style="color:var(--text-dim)">No reimbursable legs</span>'}</div></td>
      </tr>`;
  }).join('');
  buildMonthFilters();
}

function toggleExpand(id){
  const row=document.getElementById(`expand-${id}`);
  if(row) row.style.display=row.style.display==='table-row'?'none':'table-row';
}
function deleteRoute(id){
  routeDays=routeDays.filter(r=>r.id!==id);
  localStorage.setItem('alm_routes',JSON.stringify(routeDays));
  renderHistory(); updateGlobalStats();
  toast('Route removed','info');
}
function buildMonthFilters(){
  const months=[...new Set(routeDays.map(r=>r.date.slice(0,7)))].sort().reverse();
  const c=document.getElementById('monthFilters');
  c.innerHTML=`<button class="filter-chip ${currentFilter==='all'?'active':''}" onclick="filterMonth('all',this)">All</button>`;
  months.forEach(m=>{
    const[y,mo]=m.split('-');
    const label=new Date(y,mo-1).toLocaleDateString('en-US',{month:'short',year:'numeric'});
    c.innerHTML+=`<button class="filter-chip ${currentFilter===m?'active':''}" onclick="filterMonth('${m}',this)">${label}</button>`;
  });
}
function filterMonth(val,btn){
  currentFilter=val;
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active'); renderHistory();
}
function updateGlobalStats(){
  const total=routeDays.reduce((s,r)=>s+r.totalMiles,0);
  const thisMonth=new Date().toISOString().slice(0,7);
  const monthMiles=routeDays.filter(r=>r.date.startsWith(thisMonth)).reduce((s,r)=>s+r.totalMiles,0);
  const avg=routeDays.length?total/routeDays.length:0;
  document.getElementById('statTotal').textContent=total.toFixed(1);
  document.getElementById('statDays').textContent=routeDays.length;
  document.getElementById('statAvg').textContent=avg.toFixed(1);
  document.getElementById('statMonth').textContent=monthMiles.toFixed(1);
  document.getElementById('sidebarTotal').textContent=total.toFixed(1);
  document.getElementById('sidebarCount').textContent=routeDays.length;
  document.getElementById('headerTotal').textContent=`${total.toFixed(1)} MI TOTAL`;
}

// ── LOCATIONS PAGE ────────────────────────────────────────────────────────
function renderLocations(){
  const NOTES={"Home":"Personal — start/end point","ALM Corporate":"Not reimbursed from Home"};
  document.getElementById('locationsBody').innerHTML=LOCATIONS.map((l,i)=>{
    const isExcluded=l.name==='ALM Corporate', note=NOTES[l.name]||'';
    return `<tr>
      <td style="padding:14px 20px;color:var(--text-dim);font-family:var(--mono);font-size:11px">${i+1}</td>
      <td style="padding:14px 20px"><span style="font-family:var(--mono);font-size:13px;font-weight:600;color:${l.name==='Home'?'var(--green)':isExcluded?'var(--red)':'var(--text)'}">${l.name}</span></td>
      <td style="padding:14px 20px;font-family:var(--mono);font-size:12px;color:var(--text-mid)">${l.address}</td>
      <td style="padding:14px 20px">${note?`<span class="purpose-tag" style="color:${isExcluded?'var(--red)':'var(--text-dim)'};background:${isExcluded?'var(--red-dim)':'var(--surface3)'};border:1px solid ${isExcluded?'rgba(229,57,53,0.3)':'transparent'}">${note}</span>`:''}</td>
    </tr>`;
  }).join('');
}

// ── MATRIX ────────────────────────────────────────────────────────────────
function renderMatrix(){
  const w=document.getElementById('matrixWrapper');
  let html='<table class="matrix-table"><thead><tr><th class="row-header">FROM \\ TO</th>';
  LOCATIONS.forEach(l=>{ html+=`<th>${l.name.replace('ALM ','')}</th>`; });
  html+='</tr></thead><tbody>';
  LOCATIONS.forEach(from=>{
    html+=`<tr><th class="row-header">${from.name}</th>`;
    LOCATIONS.forEach(to=>{
      const key=`${from.name}|${to.name}`;
      if(from.name===to.name){ html+=`<td class="self">—</td>`; }
      else if(EXCLUDED.has(key)){ html+=`<td class="excluded">N/R</td>`; }
      else {
        const live=liveDistances[key],est=ESTIMATES[key],miles=live!==undefined?live:est,isLive=live!==undefined;
        const cls=miles<20?'green':miles<35?'yellow':miles<55?'orange':'red-cell';
        html+=`<td class="${cls}" title="${from.name} → ${to.name}: ${miles} mi"><div class="source-dot ${isLive?'live':'estimated'}"></div><div class="cell-miles">${miles}</div><div class="cell-unit">mi</div></td>`;
      }
    });
    html+='</tr>';
  });
  html+='</tbody></table>'; w.innerHTML=html;
}

// ── REFRESH ───────────────────────────────────────────────────────────────
async function refreshAllDistances(){
  const btn=document.getElementById('refreshBtn'),status=document.getElementById('refreshStatus');
  const bar=document.getElementById('progressBar'),fill=document.getElementById('progressFill');
  btn.disabled=true; bar.style.display='block';
  const pairs=[];
  LOCATIONS.forEach(a=>LOCATIONS.forEach(b=>{if(a.name!==b.name&&!EXCLUDED.has(`${a.name}|${b.name}`))pairs.push([a.name,b.name]);}));
  let done=0; const total=pairs.length;
  for(const[from,to]of pairs){
    status.innerHTML=`Fetching: <span style="color:var(--amber)">${from} → ${to}</span> (${done+1}/${total})`;
    fill.style.width=`${(done/total)*100}%`;
    const m=await fetchMapsDistance(from,to);
    if(m!==null) liveDistances[`${from}|${to}`]=m;
    done++; await new Promise(r=>setTimeout(r,100));
  }
  localStorage.setItem('maps_distances_v2',JSON.stringify(liveDistances));
  fill.style.width='100%';
  status.innerHTML=`<span style="color:var(--green)">✓ All ${total} routes refreshed from Google Maps!</span>`;
  btn.disabled=false; renderMatrix();
  toast(`${total} routes updated via Google Maps`,'success');
}

// ── EXCEL ─────────────────────────────────────────────────────────────────
function downloadExcel(){
  if(!routeDays.length){ toast('No routes to export','error'); return; }
  const wb=XLSX.utils.book_new();
  const sumData=[['Date','Total Miles','Legs','Purpose','Route','Synced to Sheets']];
  routeDays.forEach(r=>sumData.push([r.date,r.totalMiles,r.legs.length,r.purpose,r.stops.join(' → '),r.synced?'Yes':'No']));
  sumData.push(['','TOTAL',routeDays.reduce((s,r)=>s+r.totalMiles,0).toFixed(1),'','','']);
  const ws1=XLSX.utils.aoa_to_sheet(sumData); ws1['!cols']=[{wch:12},{wch:10},{wch:6},{wch:18},{wch:60},{wch:12}];
  XLSX.utils.book_append_sheet(wb,ws1,'Summary');
  const legData=[['Date','From','To','Miles','Source','Purpose']];
  routeDays.forEach(r=>r.legs.forEach(l=>legData.push([r.date,l.from,l.to,l.miles,l.source,r.purpose])));
  const ws2=XLSX.utils.aoa_to_sheet(legData); ws2['!cols']=[{wch:12},{wch:22},{wch:22},{wch:8},{wch:10},{wch:18}];
  XLSX.utils.book_append_sheet(wb,ws2,'Detailed Legs');
  const matData=[['FROM \\ TO',...LOCATIONS.map(l=>l.name)]];
  LOCATIONS.forEach(from=>{
    const row=[from.name];
    LOCATIONS.forEach(to=>{
      const key=`${from.name}|${to.name}`;
      if(from.name===to.name) row.push(0);
      else if(EXCLUDED.has(key)) row.push('N/R');
      else { const live=liveDistances[key],est=ESTIMATES[key]; row.push(live!==undefined?live:(est||'')); }
    }); matData.push(row);
  });
  const ws3=XLSX.utils.aoa_to_sheet(matData); ws3['!cols']=[{wch:22},...LOCATIONS.map(()=>({wch:14}))];
  XLSX.utils.book_append_sheet(wb,ws3,'Distance Matrix');
  XLSX.writeFile(wb,`ALM_Mileage_Tracker_${new Date().toISOString().slice(0,10)}.xlsx`);
  toast('Excel downloaded!','success');
}

// ── CHANGELOG ─────────────────────────────────────────────────────────────
const CHANGELOG = [
  {
    version: 4,
    title: 'Sheets Sync Fixes',
    date: 'Feb 2026',
    changes: [
      'Fixed URL encoding bug — "Detailed Legs" tab name was double-encoding spaces, causing 404 errors',
      'Error messages now surface in the toast so sync failures are visible and debuggable',
      'Fixed token reuse after expiry — re-auth now works cleanly from the header pill',
      'After signing in, any previously unsynced routes automatically retry and push to Sheets',
      'Removed forced consent prompt on repeat sign-ins for smoother re-authentication',
    ]
  },
  {
    version: 3,
    title: 'Google Integration',
    date: 'Feb 2026',
    changes: [
      'Replaced OpenRouteService with Google Maps Distance Matrix API for real driving distances',
      'Added Google Sheets auto-backup — every saved route syncs to Summary and Detailed Legs tabs',
      'OAuth 2.0 sign-in via Google Identity Services — one-time auth stored in localStorage',
      'Header status pills show live Maps (always on) and Sheets connection state',
      '"Synced" badge shown in Trip History for routes successfully pushed to Sheets',
      'Manual sync button to push all unsynced local routes to Sheets at once',
    ]
  },
  {
    version: 2,
    title: 'Multi-Stop Route Builder',
    date: 'Feb 2026',
    changes: [
      'Rebuilt trip entry from single A→B to a full route builder supporting up to 6 stops',
      'Visual connector UI with green start dot, amber middle stops, red end dot',
      'Live mileage badge per leg with source label (live / cached / estimated)',
      'Day total bar with per-leg breakdown and reimbursable vs N/R separation',
      'Zero-mile days supported — logs Home ↔ Corporate only days as non-reimbursable',
      'Trip History shows full stop chain with expandable leg detail rows',
      'Excel export adds Detailed Legs sheet (one row per leg) alongside Summary',
      'Corrected 6 location addresses verified against Google Maps',
      'Added Locations page showing all addresses with notes',
    ]
  },
  {
    version: 1,
    title: 'Initial Release',
    date: 'Feb 2026',
    changes: [
      'Single-file HTML app — no install, works from any browser',
      'Logged trips with date, A→B route, miles, and purpose',
      'OpenRouteService API integration for live driving distances',
      'Haversine fallback estimates when API unavailable',
      'Distance Matrix view for all 10 ALM locations',
      'Trip History with monthly filters and per-trip delete',
      'Excel export with Summary and Distance Matrix sheets',
      '10 pre-loaded ALM locations across metro Atlanta',
      'Home ↔ Corporate marked non-reimbursable and excluded from totals',
    ]
  },
];

const CURRENT_VERSION = 4;

function renderChangelog(){
  const container = document.getElementById('changelogList');
  container.innerHTML = CHANGELOG.map(entry => {
    const isCurrent = entry.version === CURRENT_VERSION;
    return `
      <div class="changelog-entry${isCurrent?' current':''}">
        <div class="cl-version-col">
          <div class="cl-version">v${entry.version}</div>
          ${isCurrent?'<div class="cl-current-badge">CURRENT</div>':''}
        </div>
        <div class="cl-body">
          <div class="cl-title">${entry.title}</div>
          <div class="cl-date">${entry.date}</div>
          <ul class="cl-changes">
            ${entry.changes.map(c=>`<li class="cl-change"><span class="cl-bullet">→</span><span>${c}</span></li>`).join('')}
          </ul>
        </div>
      </div>`;
  }).join('');
}

// ── NAV ───────────────────────────────────────────────────────────────────
function showPage(id,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='matrix') renderMatrix();
  if(id==='history') renderHistory();
  if(id==='locations') renderLocations();
  if(id==='changelog') renderChangelog();
}

// ── UTILS ─────────────────────────────────────────────────────────────────
function fmtDate(d){ if(!d)return''; const[y,m,day]=d.split('-'); return`${m}/${day}/${y}`; }
function toast(msg,type='info'){
  const c=document.getElementById('toastContainer'),t=document.createElement('div');
  t.className=`toast ${type}`;
  const icons={success:'✓',error:'✗',info:'→',sheets:'⬆'};
  const colors={success:'var(--green)',error:'var(--red)',info:'var(--amber)',sheets:'var(--blue)'};
  t.innerHTML=`<span style="color:${colors[type]||'var(--amber)'}">${icons[type]||'→'}</span> ${msg}`;
  c.appendChild(t); setTimeout(()=>t.remove(),3500);
}
</script>
</body>
</html>
