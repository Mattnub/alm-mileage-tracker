<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALM Mileage Tracker v13</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #1c1c1c;
            border-right: 1px solid #2a2a2a;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-logo {
            padding: 0 20px 30px 20px;
            border-bottom: 1px solid #2a2a2a;
            margin-bottom: 30px;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #ffa726;
            margin-bottom: 5px;
        }

        .logo-subtitle {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 0 20px;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #ccc;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #ffa726;
            color: #000;
            border-left-color: #ffa726;
        }

        .nav-item-icon {
            width: 16px;
            height: 16px;
            margin-right: 12px;
            font-size: 14px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            background: #141414;
        }

        /* Top Bar */
        .top-bar {
            background: #1c1c1c;
            border-bottom: 1px solid #2a2a2a;
            padding: 15px 30px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pill.maps-active {
            background: #22c55e;
            color: white;
        }

        .status-pill.sheets-signin {
            background: #ef4444;
            color: white;
        }

        .status-pill.total-miles {
            background: #ffa726;
            color: black;
            font-weight: 700;
        }

        /* Page Content */
        .page-content {
            padding: 30px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Route Builder Card */
        .route-card {
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
        }

        .route-card-header {
            background: #252525;
            padding: 20px 25px;
            border-bottom: 1px solid #2a2a2a;
        }

        .section-title {
            color: #ffa726;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 16px;
            background: #ffa726;
            margin-right: 10px;
        }

        .route-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-field input,
        .form-field select {
            background: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 12px 15px;
            color: #fff;
            font-size: 14px;
        }

        .form-field input:focus,
        .form-field select:focus {
            border-color: #ffa726;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 167, 38, 0.1);
        }

        /* Route Builder */
        .route-builder {
            padding: 25px;
        }

        .stops-section {
            margin-bottom: 30px;
        }

        .stop-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 167, 38, 0.06);
            border: 1px solid rgba(255, 167, 38, 0.2);
            border-radius: 6px;
        }

        .stop-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .stop-indicator.start {
            background: #22c55e;
        }

        .stop-indicator.middle {
            background: #ffa726;
        }

        .stop-indicator.end {
            background: #ef4444;
        }

        .stop-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 80px;
        }

        .stop-select {
            flex: 1;
            background: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
        }

        .stop-distance {
            background: #ffa726;
            color: #000;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            min-width: 60px;
            text-align: center;
        }

        .stop-remove {
            background: #333;
            border: none;
            color: #999;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stop-remove:hover {
            background: #ef4444;
            color: white;
        }

        .add-stop-btn {
            background: transparent;
            border: 1px dashed #666;
            color: #999;
            padding: 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-stop-btn:hover {
            border-color: #ffa726;
            color: #ffa726;
        }

        /* Day Total */
        .day-total {
            background: #252525;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .total-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .total-value {
            font-size: 36px;
            font-weight: 700;
            color: #ffa726;
        }

        .total-unit {
            font-size: 14px;
            color: #999;
            margin-left: 5px;
        }

        .total-note {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
        }

        /* Map Preview */
        .map-preview {
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
        }

        .map-preview-header {
            background: #252525;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2a2a2a;
        }

        .map-preview-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #ffa726;
        }

        .map-container {
            width: 100%;
            height: 400px;
            background: #141414;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-clear {
            background: #333;
            color: #ccc;
        }

        .btn-clear:hover {
            background: #444;
        }

        .btn-preview {
            background: transparent;
            border: 1px solid #ffa726;
            color: #ffa726;
        }

        .btn-preview:hover {
            background: #ffa726;
            color: #000;
        }

        .btn-save {
            background: #ffa726;
            color: #000;
        }

        .btn-save:hover {
            background: #ff9800;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Draft Banner */
        .draft-banner {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: #000;
            padding: 15px 25px;
            margin-bottom: 25px;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .draft-banner.show {
            display: block;
        }

        .draft-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .draft-btn {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(0, 0, 0, 0.3);
            color: #000;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .draft-btn:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            font-size: 13px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #ffa726;
            color: #000;
        }

        /* Hidden pages */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .main-content {
                margin-left: 0;
            }

            .route-form {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Conflict Resolution Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .conflict-modal {
            background: #1c1c1c;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            background: #252525;
            padding: 20px 25px;
            border-bottom: 1px solid #2a2a2a;
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            color: #ffa726;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .modal-subtitle {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .modal-body {
            padding: 25px;
        }

        .conflicts-list {
            margin-bottom: 20px;
        }

        .conflict-item {
            background: rgba(255, 167, 38, 0.06);
            border: 1px solid rgba(255, 167, 38, 0.2);
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .conflict-item.resolved-overwrite {
            background: rgba(239, 68, 68, 0.06);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .conflict-item.resolved-skip {
            background: rgba(102, 102, 102, 0.06);
            border-color: rgba(102, 102, 102, 0.2);
            opacity: 0.7;
        }

        .conflict-item.resolved-keep-both {
            background: rgba(34, 197, 94, 0.06);
            border-color: rgba(34, 197, 94, 0.2);
        }

        .conflict-header {
            background: rgba(255, 167, 38, 0.1);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 167, 38, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conflict-date {
            font-size: 16px;
            font-weight: 700;
            color: #ffa726;
        }

        .conflict-indicator {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .conflict-comparison {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .conflict-side {
            background: #141414;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
        }

        .conflict-side h4 {
            color: #ffa726;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .conflict-detail {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        .conflict-label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .conflict-value {
            color: #fff;
            font-weight: 600;
        }

        .conflict-actions {
            padding: 15px 20px;
            background: #252525;
            border-top: 1px solid #2a2a2a;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-adjustment {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: auto;
        }

        .date-adjustment label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .date-adjustment input {
            background: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            width: 140px;
        }

        .conflict-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .conflict-btn.overwrite {
            background: #ef4444;
            color: white;
        }

        .conflict-btn.overwrite:hover {
            background: #dc2626;
        }

        .conflict-btn.skip {
            background: #666;
            color: white;
        }

        .conflict-btn.skip:hover {
            background: #777;
        }

        .conflict-btn.keep-both {
            background: #22c55e;
            color: white;
        }

        .conflict-btn.keep-both:hover {
            background: #16a34a;
        }

        .modal-footer {
            background: #252525;
            padding: 20px 25px;
            border-top: 1px solid #2a2a2a;
            border-radius: 0 0 12px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
        }

        .conflicts-summary {
            color: #666;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .conflict-comparison {
                grid-template-columns: 1fr;
            }
            
            .conflict-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .date-adjustment {
                margin-right: 0;
                justify-content: center;
            }
        }

        /* Dashboard Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #141414;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
        }

        .data-table th {
            background: #252525;
            color: #ffa726;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
            color: #fff;
            font-size: 13px;
        }

        .data-table tr:hover {
            background: rgba(255, 167, 38, 0.05);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Location Grid */
        .locations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .location-card {
            background: #141414;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 20px;
            transition: all 0.2s;
        }

        .location-card:hover {
            border-color: #ffa726;
            transform: translateY(-2px);
        }

        .location-name {
            color: #ffa726;
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .location-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .location-type.home {
            background: #22c55e;
            color: white;
        }

        .location-type.corporate {
            background: #ef4444;
            color: white;
        }

        .location-type.dealership {
            background: #ffa726;
            color: black;
        }

        .location-address {
            color: #ccc;
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .location-coords {
            color: #666;
            font-size: 11px;
            font-family: monospace;
        }

        /* Distance Matrix */
        .distance-matrix-container {
            overflow-x: auto;
        }

        .distance-matrix {
            min-width: 800px;
        }

        .distance-matrix th,
        .distance-matrix td {
            min-width: 80px;
            text-align: center;
        }

        .distance-matrix .location-header {
            background: #ffa726;
            color: black;
            font-weight: 700;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 4px;
        }

        .distance-cell {
            color: #ffa726;
            font-weight: 600;
        }

        .distance-cell.unavailable {
            color: #666;
            font-style: italic;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: #141414;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #ffa726;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-badge.reimbursable {
            background: #22c55e;
            color: white;
        }

        .status-badge.non-reimbursable {
            background: #ef4444;
            color: white;
        }

        .status-badge.synced {
            background: #22c55e;
            color: white;
        }

        .status-badge.unsynced {
            background: #666;
            color: white;
        }

        /* Changelog */
        .changelog-content {
            max-height: 600px;
            overflow-y: auto;
        }

        .changelog-version {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .changelog-version:last-child {
            border-bottom: none;
        }

        .changelog-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .version-number {
            background: #ffa726;
            color: black;
            padding: 6px 12px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 14px;
        }

        .version-date {
            color: #666;
            font-size: 12px;
        }

        .changelog-features {
            list-style: none;
            padding: 0;
        }

        .changelog-features li {
            padding: 8px 0;
            color: #ccc;
            position: relative;
            padding-left: 20px;
        }

        .changelog-features li::before {
            content: '‚Ä¢';
            color: #ffa726;
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .locations-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .route-form[style*="grid-template-columns: repeat(4, 1fr)"] {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .distance-matrix-container {
                position: relative;
            }
            
            .distance-matrix-container::after {
                content: 'Scroll horizontally to view all columns ‚Üí';
                position: absolute;
                bottom: -25px;
                right: 0;
                color: #666;
                font-size: 11px;
                font-style: italic;
            }
        }

        /* Distance Matrix Improvements */
        .distance-matrix-container {
            overflow-x: auto;
            overflow-y: visible;
            max-width: 100%;
            border: 1px solid #333;
            border-radius: 6px;
            background: #141414;
        }

        .distance-matrix {
            min-width: 900px;
            width: max-content;
            margin: 0;
        }

        .distance-matrix th:first-child,
        .distance-matrix td:first-child {
            position: sticky;
            left: 0;
            background: #252525;
            z-index: 2;
            border-right: 2px solid #333;
        }

        /* Print Styles */
        @media print {
            /* Hide navigation and non-essential elements */
            .sidebar,
            .top-bar,
            .modal-overlay,
            .toast,
            .draft-banner,
            .btn,
            button,
            .action-buttons,
            .conflict-actions,
            .nav-item,
            .map-preview,
            .map-container {
                display: none !important;
            }
            
            /* Adjust main content for print */
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .page-content {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Page breaks */
            .route-card {
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .page-header {
                page-break-after: avoid;
                margin-bottom: 20px;
            }
            
            /* Print-friendly colors */
            body {
                background: white !important;
                color: black !important;
            }
            
            .route-card,
            .route-card-header {
                background: white !important;
                border: 1px solid #000 !important;
                color: black !important;
            }
            
            .data-table {
                background: white !important;
                border-collapse: collapse !important;
            }
            
            .data-table th {
                background: #f0f0f0 !important;
                color: black !important;
                border: 1px solid #000 !important;
            }
            
            .data-table td {
                color: black !important;
                border: 1px solid #000 !important;
            }
            
            /* Print headers */
            .page-title {
                color: black !important;
                font-size: 24px !important;
            }
            
            .page-subtitle {
                color: #666 !important;
            }
            
            .section-title {
                color: black !important;
            }
            
            .section-title::before {
                background: black !important;
            }
            
            /* Status badges for print */
            .status-badge {
                border: 1px solid #000 !important;
                background: white !important;
                color: black !important;
            }
            
            /* Stats and numbers */
            .stat-value,
            .total-value,
            .conflict-value {
                color: black !important;
            }
            
            /* Print page setup */
            @page {
                size: A4;
                margin: 0.75in;
            }
            
            /* Force page title to show */
            .page-header::before {
                content: "ALM Mileage Tracker - Printed Report";
                display: block;
                font-size: 12px;
                color: #666;
                margin-bottom: 10px;
                text-align: right;
            }
            
            /* Print date */
            .page-header::after {
                content: "Generated: " attr(data-print-date);
                display: block;
                font-size: 10px;
                color: #666;
                text-align: right;
                margin-top: 5px;
            }
        }

        /* Print button styling */
        .print-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 167, 38, 0.1);
            border: 1px solid rgba(255, 167, 38, 0.3);
            border-radius: 6px;
            text-align: center;
        }

        .print-btn {
            background: #ffa726;
            color: black;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 5px;
        }

        .print-btn:hover {
            background: #ff9800;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-text">ALM</div>
                <div class="logo-subtitle">MILEAGE TRACKER v13</div>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">LOG</div>
                <a href="#" class="nav-item active" data-page="log">
                    <span class="nav-item-icon">+</span>
                    New Route
                </a>
                <a href="#" class="nav-item" data-page="history">
                    <span class="nav-item-icon">‚è±</span>
                    Trip History
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">DATA</div>
                <a href="#" class="nav-item" data-page="locations">
                    <span class="nav-item-icon">üìç</span>
                    Locations
                </a>
                <a href="#" class="nav-item" data-page="matrix">
                    <span class="nav-item-icon">‚äû</span>
                    Distance Matrix
                </a>
                <a href="#" class="nav-item" onclick="refreshDistances()">
                    <span class="nav-item-icon">‚ü≤</span>
                    Refresh Distances
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">ANALYSIS</div>
                <a href="#" class="nav-item" data-page="charts">
                    <span class="nav-item-icon">üìä</span>
                    Charts
                </a>
                <a href="#" class="nav-item" data-page="cost">
                    <span class="nav-item-icon">$</span>
                    Cost Report
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">EXPORT</div>
                <a href="#" class="nav-item" onclick="downloadExcel()">
                    <span class="nav-item-icon">‚Üì</span>
                    Download Excel
                </a>
                <a href="#" class="nav-item" onclick="importExcel()">
                    <span class="nav-item-icon">‚Üë</span>
                    Import Excel
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">APP</div>
                <a href="#" class="nav-item" data-page="changelog">
                    <span class="nav-item-icon">üìã</span>
                    Changelog
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="status-pill maps-active" id="maps-status">
                    ‚óè MAPS ACTIVE
                </div>
                <div class="status-pill sheets-signin" id="sheets-status">
                    ‚óè SHEETS: SIGN IN
                </div>
                <div class="status-pill total-miles">
                    <span id="total-miles-display">0.0</span> MI TOTAL
                </div>
            </div>

            <!-- Draft Banner -->
            <div class="draft-banner" id="draft-banner">
                DRAFT FOUND - You have an unsaved route in progress
                <div class="draft-actions">
                    <button class="draft-btn" onclick="resumeDraft()">Resume Draft</button>
                    <button class="draft-btn" onclick="discardDraft()">Discard Draft</button>
                </div>
            </div>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Log Trip Page -->
                <div class="page active" id="log-page">
                    <div class="page-header">
                        <h1 class="page-title">New Route</h1>
                        <p class="page-subtitle">BUILD YOUR DAY'S STOPS - UP TO 6 LOCATIONS</p>
                    </div>

                    <!-- Route Card -->
                    <div class="route-card">
                        <!-- Route Details Header -->
                        <div class="route-card-header">
                            <div class="section-title">Route Details</div>
                            <form class="route-form">
                                <div class="form-field">
                                    <label>Date</label>
                                    <input type="date" id="trip-date">
                                </div>
                                <div class="form-field">
                                    <label>Purpose</label>
                                    <select id="trip-purpose">
                                        <option value="">Dealership Visits</option>
                                        <option value="Sales Visit">Sales Visit</option>
                                        <option value="Service Call">Service Call</option>
                                        <option value="Training">Training</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Delivery">Delivery</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </form>
                        </div>

                        <!-- Route Builder -->
                        <div class="route-builder">
                            <div class="stops-section">
                                <div id="stops-list">
                                    <!-- Stop items will be added dynamically -->
                                </div>
                                <button class="add-stop-btn" onclick="addStop()" id="add-stop-btn">
                                    + Add Stop
                                    <span id="stop-count">2 locations ‚Ä¢ 1 legs</span>
                                </button>
                            </div>

                            <!-- Day Total -->
                            <div class="day-total" id="day-total" style="display: none;">
                                <div class="total-label">Day Total</div>
                                <div class="total-value" id="total-value">
                                    0.0<span class="total-unit">miles</span>
                                </div>
                                <div class="total-note">Add stops to see breakdown</div>
                            </div>

                            <!-- Map Preview -->
                            <div class="map-preview" id="map-preview" style="display: none;">
                                <div class="map-preview-header">
                                    <div class="map-preview-title">Route Preview</div>
                                    <button class="btn btn-clear" onclick="toggleMapPreview()" id="map-toggle-btn">
                                        Hide Map
                                    </button>
                                </div>
                                <div class="map-container" id="map-container">
                                    <div>Loading route preview...</div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-clear" onclick="clearRoute()">Clear</button>
                                <button class="btn btn-preview" onclick="previewRoute()" id="preview-btn" disabled>
                                    Preview Route
                                </button>
                                <button class="btn btn-save" onclick="saveRoute()" id="save-btn" disabled>
                                    Save Route
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder pages -->
                <!-- Trip History Page -->
                <div class="page" id="history-page">
                    <div class="page-header">
                        <h1 class="page-title">Trip History</h1>
                        <p class="page-subtitle">VIEW AND MANAGE YOUR SAVED ROUTES</p>
                    </div>
                    
                    <!-- Filters -->
                    <div class="route-card" style="margin-bottom: 20px;">
                        <div class="route-card-header">
                            <div class="section-title">Filters</div>
                            <div class="route-form" style="grid-template-columns: repeat(4, 1fr);">
                                <div class="form-field">
                                    <label>Month</label>
                                    <select id="filter-month" onchange="filterHistory()">
                                        <option value="">All Months</option>
                                        <option value="2026-01">Jan 2026</option>
                                        <option value="2026-02">Feb 2026</option>
                                        <option value="2026-03">Mar 2026</option>
                                        <option value="2026-04">Apr 2026</option>
                                        <option value="2026-05">May 2026</option>
                                        <option value="2026-06">Jun 2026</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Purpose</label>
                                    <select id="filter-purpose" onchange="filterHistory()">
                                        <option value="">All Purposes</option>
                                        <option value="Sales Visit">Sales Visit</option>
                                        <option value="Service Call">Service Call</option>
                                        <option value="Training">Training</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Delivery">Delivery</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Status</label>
                                    <select id="filter-status" onchange="filterHistory()">
                                        <option value="">All</option>
                                        <option value="reimbursable">Reimbursable</option>
                                        <option value="non-reimbursable">Non-Reimbursable</option>
                                        <option value="synced">Synced</option>
                                        <option value="unsynced">Unsynced</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Actions</label>
                                    <button class="btn btn-preview" onclick="clearFilters()" style="width: 100%;">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- History Table -->
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Route History</div>
                        </div>
                        <div class="route-builder">
                            <!-- Print Section -->
                            <div class="print-section">
                                <h4 style="margin: 0 0 10px 0; color: #ffa726;">Print Reports</h4>
                                <button class="print-btn" onclick="printCurrentView()">üñ®Ô∏è Print Current View</button>
                                <button class="print-btn" onclick="printFilteredData()">üìÑ Print Filtered Data</button>
                            </div>
                            
                            <div id="history-table-container">
                                <!-- History table will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Locations Page -->
                <div class="page" id="locations-page">
                    <div class="page-header">
                        <h1 class="page-title">Locations</h1>
                        <p class="page-subtitle">ALM DEALERSHIP AND OFFICE LOCATIONS</p>
                    </div>
                    
                    <!-- Add New Location -->
                    <div class="route-card" style="margin-bottom: 20px;">
                        <div class="route-card-header">
                            <div class="section-title">Add New Location</div>
                        </div>
                        <div class="route-builder">
                            <div class="route-form" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 20px;">
                                <div class="form-field">
                                    <label>Location Name</label>
                                    <input type="text" id="new-location-name" placeholder="e.g., ALM Alpharetta" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label>Full Address</label>
                                    <input type="text" id="new-location-address" placeholder="Street, City, State ZIP" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label>Location Type</label>
                                    <select id="new-location-type" class="form-control">
                                        <option value="dealership">Dealership</option>
                                        <option value="corporate">Corporate Office</option>
                                        <option value="home">Home/Personal</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="route-form" style="grid-template-columns: 1fr 1fr 1fr auto; align-items: end;">
                                <div class="form-field">
                                    <label>Latitude</label>
                                    <input type="number" id="new-location-lat" step="0.000001" placeholder="34.123456" class="form-control">
                                </div>
                                <div class="form-field">
                                    <label>Longitude</label>
                                    <input type="number" id="new-location-lng" step="0.000001" placeholder="-84.123456" class="form-control">
                                </div>
                                <div class="form-field">
                                    <button class="btn btn-secondary" onclick="geocodeAddress()" id="geocode-btn">
                                        üìç Get Coordinates
                                    </button>
                                </div>
                                <div class="form-field">
                                    <button class="btn btn-save" onclick="addNewLocation()">
                                        Add Location
                                    </button>
                                </div>
                            </div>
                            <div style="margin-top: 15px; padding: 10px; background: rgba(255, 167, 38, 0.1); border-radius: 4px; font-size: 13px; color: #ccc;">
                                üí° <strong>Tip:</strong> Enter the address and click "Get Coordinates" to automatically fill latitude/longitude, or find coordinates manually using Google Maps.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Existing Locations -->
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Location Directory</div>
                        </div>
                        <div class="route-builder">
                            <div id="locations-grid" class="locations-grid">
                                <!-- Locations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Matrix Page -->
                <div class="page" id="matrix-page">
                    <div class="page-header">
                        <h1 class="page-title">Distance Matrix</h1>
                        <p class="page-subtitle">LOCATION-TO-LOCATION DISTANCE GRID</p>
                    </div>
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Distance Matrix</div>
                        </div>
                        <div class="route-builder">
                            <div id="distance-matrix-container" class="distance-matrix-container">
                                <!-- Distance matrix table will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Page -->
                <div class="page" id="charts-page">
                    <div class="page-header">
                        <h1 class="page-title">Charts</h1>
                        <p class="page-subtitle">MILEAGE ANALYTICS AND TRENDS</p>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="route-card">
                            <div class="route-card-header">
                                <div class="section-title">Monthly Miles</div>
                            </div>
                            <div class="route-builder">
                                <canvas id="monthly-chart" width="400" height="300"></canvas>
                            </div>
                        </div>
                        
                        <div class="route-card">
                            <div class="route-card-header">
                                <div class="section-title">Purpose Breakdown</div>
                            </div>
                            <div class="route-builder">
                                <canvas id="purpose-chart" width="400" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Summary -->
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Statistics Summary</div>
                        </div>
                        <div class="route-builder">
                            <div id="stats-summary" class="stats-grid">
                                <!-- Stats will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Report Page -->
                <div class="page" id="cost-page">
                    <div class="page-header">
                        <h1 class="page-title">Cost Report</h1>
                        <p class="page-subtitle">REIMBURSEMENT CALCULATIONS</p>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div class="route-card">
                            <div class="route-builder" style="text-align: center; padding: 30px;">
                                <div style="font-size: 32px; font-weight: 700; color: #ffa726;" id="total-miles-card">0</div>
                                <div style="color: #666; margin-top: 8px; text-transform: uppercase; letter-spacing: 1px;">Total Miles</div>
                            </div>
                        </div>
                        
                        <div class="route-card">
                            <div class="route-builder" style="text-align: center; padding: 30px;">
                                <div style="font-size: 32px; font-weight: 700; color: #22c55e;" id="total-reimbursement-card">$0</div>
                                <div style="color: #666; margin-top: 8px; text-transform: uppercase; letter-spacing: 1px;">Total Reimbursement</div>
                            </div>
                        </div>
                        
                        <div class="route-card">
                            <div class="route-builder" style="text-align: center; padding: 30px;">
                                <div style="font-size: 32px; font-weight: 700; color: #ef4444;" id="irs-rate-card">$0.70</div>
                                <div style="color: #666; margin-top: 8px; text-transform: uppercase; letter-spacing: 1px;">IRS Rate/Mile</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Breakdown -->
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Monthly Breakdown</div>
                        </div>
                        <div class="route-builder">
                            <!-- Print Section -->
                            <div class="print-section">
                                <h4 style="margin: 0 0 10px 0; color: #ffa726;">Print Cost Report</h4>
                                <button class="print-btn" onclick="printCostReport()">üñ®Ô∏è Print Cost Report</button>
                                <button class="print-btn" onclick="printMonthlySummary()">üìä Print Monthly Summary</button>
                            </div>
                            
                            <div id="monthly-cost-table">
                                <!-- Monthly cost table will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Changelog Page -->
                <div class="page" id="changelog-page">
                    <div class="page-header">
                        <h1 class="page-title">Changelog</h1>
                        <p class="page-subtitle">VERSION HISTORY AND UPDATES</p>
                    </div>
                    <div class="route-card">
                        <div class="route-card-header">
                            <div class="section-title">Version History</div>
                        </div>
                        <div class="route-builder">
                            <div id="changelog-content" class="changelog-content">
                                <!-- Changelog content will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Conflict Resolution Modal -->
    <div class="modal-overlay" id="conflict-modal">
        <div class="conflict-modal">
            <div class="modal-header">
                <h2 class="modal-title">Import Conflicts Detected</h2>
                <div class="modal-subtitle">Resolve data conflicts before importing</div>
            </div>
            <div class="modal-body">
                <div class="conflicts-list" id="conflicts-list">
                    <!-- Conflicts will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="conflicts-summary">
                    <span id="conflicts-remaining">0</span> conflicts remaining
                </div>
                <div class="bulk-actions">
                    <button class="btn btn-clear" onclick="cancelImport()">Cancel Import</button>
                    <button class="conflict-btn skip" onclick="bulkResolve('skip')">Skip All</button>
                    <button class="conflict-btn overwrite" onclick="bulkResolve('overwrite')">Overwrite All</button>
                    <button class="btn btn-preview" onclick="proceedWithImport()" id="proceed-btn" disabled>
                        Proceed with Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Maps API -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBjlBfZykUSXuKi-O3OGJ4YTfiI4H3CpdE&callback=initMap&libraries=geometry"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS for Excel import/export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // Constants
        const MAX_STOPS = 6;
        const GOOGLE_API_KEY = 'AIzaSyBjlBfZykUSXuKi-O3OGJ4YTfiI4H3CpdE';
        const IRS_RATE = 0.70; // $0.70 per mile for 2025
        
        // ALM Locations (verified coordinates)
        const ALM_LOCATIONS = {
            'home': {
                name: 'Home',
                address: '216 Winterbury Dr, Canton, GA 30114',
                lat: 34.2364,
                lng: -84.4903,
                type: 'home'
            },
            'corporate': {
                name: 'ALM Corporate',
                address: '6625 The Corners Pkwy NW, Norcross, GA 30092',
                lat: 33.9410,
                lng: -84.2140,
                type: 'corporate'
            },
            'kennesaw': {
                name: 'ALM Kennesaw',
                address: '3905 Cherokee St NW, Kennesaw, GA 30144',
                lat: 34.0234,
                lng: -84.6199,
                type: 'dealership'
            },
            'marietta': {
                name: 'ALM Marietta',
                address: '750 Cobb Pkwy S, Marietta, GA 30060',
                lat: 33.9370,
                lng: -84.5220,
                type: 'dealership'
            },
            'gwinnett': {
                name: 'ALM Gwinnett',
                address: '2520 Pleasant Hill Rd, Duluth, GA 30096',
                lat: 33.9567,
                lng: -84.1442,
                type: 'dealership'
            },
            'buford': {
                name: 'ALM Buford',
                address: '4805 Browns Bridge Rd, Buford, GA 30518',
                lat: 34.1212,
                lng: -83.9932,
                type: 'dealership'
            },
            'roswell': {
                name: 'ALM Roswell',
                address: '11205 Alpharetta Hwy, Roswell, GA 30076',
                lat: 34.0754,
                lng: -84.3052,
                type: 'dealership'
            },
            'newnan': {
                name: 'ALM Newnan',
                address: '1405 Newnan Crossing Bypass, Newnan, GA 30265',
                lat: 33.3668,
                lng: -84.7796,
                type: 'dealership'
            },
            'mcdonough': {
                name: 'ALM McDonough',
                address: '1550 Highway 20/81 E, McDonough, GA 30253',
                lat: 33.4734,
                lng: -84.1468,
                type: 'dealership'
            }
        };

        // Global variables
        let currentRoute = [];
        let totalDistance = 0;
        let map = null;
        let directionsService = null;
        let directionsRenderer = null;
        let isMapInitialized = false;
        let importConflicts = [];
        let conflictResolutions = {};

        // Conflict Resolution System
        function detectConflicts(newRoutes, existingRoutes) {
            const conflicts = [];
            const existingByDate = {};
            
            // Index existing routes by date for fast lookup
            existingRoutes.forEach(route => {
                if (!existingByDate[route.date]) {
                    existingByDate[route.date] = [];
                }
                existingByDate[route.date].push(route);
            });
            
            // Check each new route for conflicts
            newRoutes.forEach((newRoute, index) => {
                const existingForDate = existingByDate[newRoute.date];
                if (existingForDate && existingForDate.length > 0) {
                    // Found conflict(s) for this date
                    existingForDate.forEach(existing => {
                        conflicts.push({
                            id: `conflict_${index}_${existing.id}`,
                            date: newRoute.date,
                            existing: existing,
                            incoming: newRoute,
                            resolution: null,
                            adjustedDate: newRoute.date
                        });
                    });
                }
            });
            
            return conflicts;
        }

        function showConflictModal(conflicts) {
            importConflicts = conflicts;
            conflictResolutions = {};
            
            const modal = document.getElementById('conflict-modal');
            const conflictsList = document.getElementById('conflicts-list');
            
            conflictsList.innerHTML = '';
            
            conflicts.forEach(conflict => {
                const conflictElement = createConflictElement(conflict);
                conflictsList.appendChild(conflictElement);
            });
            
            updateConflictsRemaining();
            modal.classList.add('show');
        }

        function createConflictElement(conflict) {
            const div = document.createElement('div');
            div.className = 'conflict-item';
            div.dataset.conflictId = conflict.id;
            
            // Suggest next available date
            const suggestedDate = findNextAvailableDate(conflict.date);
            conflict.adjustedDate = suggestedDate;
            
            div.innerHTML = `
                <div class="conflict-header">
                    <div class="conflict-date">${formatDate(conflict.date)}</div>
                    <div class="conflict-indicator">Conflict</div>
                </div>
                <div class="conflict-comparison">
                    <div class="conflict-side">
                        <h4>Existing Data</h4>
                        <div class="conflict-detail">
                            <span class="conflict-label">Purpose:</span>
                            <span class="conflict-value">${conflict.existing.purpose}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Route:</span>
                            <span class="conflict-value">${formatRoute(conflict.existing.stops)}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Miles:</span>
                            <span class="conflict-value">${conflict.existing.totalMiles}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Cost:</span>
                            <span class="conflict-value">$${conflict.existing.cost.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="conflict-side">
                        <h4>Incoming Data</h4>
                        <div class="conflict-detail">
                            <span class="conflict-label">Purpose:</span>
                            <span class="conflict-value">${conflict.incoming.purpose}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Route:</span>
                            <span class="conflict-value">${formatRoute(conflict.incoming.stops)}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Miles:</span>
                            <span class="conflict-value">${conflict.incoming.totalMiles}</span>
                        </div>
                        <div class="conflict-detail">
                            <span class="conflict-label">Cost:</span>
                            <span class="conflict-value">$${conflict.incoming.cost.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                <div class="conflict-actions">
                    <div class="date-adjustment">
                        <label>Adjust Date:</label>
                        <input type="date" value="${suggestedDate}" onchange="updateAdjustedDate('${conflict.id}', this.value)">
                    </div>
                    <button class="conflict-btn overwrite" onclick="resolveConflict('${conflict.id}', 'overwrite')">
                        Overwrite
                    </button>
                    <button class="conflict-btn skip" onclick="resolveConflict('${conflict.id}', 'skip')">
                        Skip
                    </button>
                    <button class="conflict-btn keep-both" onclick="resolveConflict('${conflict.id}', 'keep-both')">
                        Keep Both
                    </button>
                </div>
            `;
            
            return div;
        }

        function findNextAvailableDate(originalDate) {
            const existingRoutes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            const existingDates = new Set(existingRoutes.map(r => r.date));
            
            let testDate = new Date(originalDate + 'T00:00:00');
            testDate.setDate(testDate.getDate() + 1); // Start with next day
            
            // Find next available date (up to 30 days ahead)
            for (let i = 0; i < 30; i++) {
                const testDateStr = testDate.toISOString().split('T')[0];
                if (!existingDates.has(testDateStr)) {
                    return testDateStr;
                }
                testDate.setDate(testDate.getDate() + 1);
            }
            
            // If no available date found in 30 days, just return tomorrow
            testDate = new Date(originalDate + 'T00:00:00');
            testDate.setDate(testDate.getDate() + 1);
            return testDate.toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatRoute(stops) {
            if (!stops || stops.length === 0) return 'No route';
            if (stops.length === 1) return stops[0].name;
            if (stops.length === 2) return `${stops[0].name} ‚Üí ${stops[1].name}`;
            return `${stops[0].name} ‚Üí ... ‚Üí ${stops[stops.length - 1].name} (${stops.length} stops)`;
        }

        function updateAdjustedDate(conflictId, newDate) {
            const conflict = importConflicts.find(c => c.id === conflictId);
            if (conflict) {
                conflict.adjustedDate = newDate;
                
                // If date is changed and resolution was 'keep-both', automatically apply it
                if (newDate !== conflict.date && conflictResolutions[conflictId] !== 'keep-both') {
                    resolveConflict(conflictId, 'keep-both');
                }
            }
        }

        function resolveConflict(conflictId, resolution) {
            const conflict = importConflicts.find(c => c.id === conflictId);
            if (!conflict) return;
            
            conflictResolutions[conflictId] = resolution;
            conflict.resolution = resolution;
            
            // Update UI to show resolution
            const conflictElement = document.querySelector(`[data-conflict-id="${conflictId}"]`);
            if (conflictElement) {
                // Remove previous resolution classes
                conflictElement.classList.remove('resolved-overwrite', 'resolved-skip', 'resolved-keep-both');
                
                // Add new resolution class
                conflictElement.classList.add(`resolved-${resolution}`);
                
                // Update conflict indicator
                const indicator = conflictElement.querySelector('.conflict-indicator');
                const resolutionText = {
                    'overwrite': 'Will Overwrite',
                    'skip': 'Will Skip',
                    'keep-both': 'Will Keep Both'
                };
                indicator.textContent = resolutionText[resolution];
                indicator.style.background = {
                    'overwrite': '#ef4444',
                    'skip': '#666',
                    'keep-both': '#22c55e'
                }[resolution];
            }
            
            updateConflictsRemaining();
        }

        function bulkResolve(resolution) {
            importConflicts.forEach(conflict => {
                if (!conflictResolutions[conflict.id]) {
                    resolveConflict(conflict.id, resolution);
                }
            });
            
            showToast(`Applied "${resolution}" to all unresolved conflicts`, 'success');
        }

        function updateConflictsRemaining() {
            const resolved = Object.keys(conflictResolutions).length;
            const remaining = importConflicts.length - resolved;
            
            document.getElementById('conflicts-remaining').textContent = remaining;
            document.getElementById('proceed-btn').disabled = remaining > 0;
        }

        function cancelImport() {
            const modal = document.getElementById('conflict-modal');
            modal.classList.remove('show');
            importConflicts = [];
            conflictResolutions = {};
            showToast('Import cancelled', 'warning');
        }

        function proceedWithImport() {
            // Apply all resolutions and import the data
            const existingRoutes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            let finalRoutes = [...existingRoutes];
            let addedCount = 0;
            let overwrittenCount = 0;
            let skippedCount = 0;
            
            importConflicts.forEach(conflict => {
                const resolution = conflictResolutions[conflict.id];
                
                switch (resolution) {
                    case 'overwrite':
                        // Replace existing entry with new one
                        const existingIndex = finalRoutes.findIndex(r => r.id === conflict.existing.id);
                        if (existingIndex !== -1) {
                            finalRoutes[existingIndex] = {
                                ...conflict.incoming,
                                id: conflict.existing.id // Keep original ID
                            };
                            overwrittenCount++;
                        }
                        break;
                        
                    case 'skip':
                        // Do nothing - skip the incoming entry
                        skippedCount++;
                        break;
                        
                    case 'keep-both':
                        // Add new entry with adjusted date if needed
                        const newEntry = {
                            ...conflict.incoming,
                            date: conflict.adjustedDate,
                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9)
                        };
                        finalRoutes.push(newEntry);
                        addedCount++;
                        break;
                }
            });
            
            // Save the final routes
            localStorage.setItem('alm_routes', JSON.stringify(finalRoutes));
            
            // Close modal and show success message
            const modal = document.getElementById('conflict-modal');
            modal.classList.remove('show');
            
            const summary = [];
            if (addedCount > 0) summary.push(`${addedCount} added`);
            if (overwrittenCount > 0) summary.push(`${overwrittenCount} overwritten`);
            if (skippedCount > 0) summary.push(`${skippedCount} skipped`);
            
            showToast(`Import completed: ${summary.join(', ')}`, 'success');
            
            // Reset conflict state
            importConflicts = [];
            conflictResolutions = {};
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkDraft();
            updateStatus();
        });

        function initializeApp() {
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trip-date').value = today;
            
            // Load custom locations into ALM_LOCATIONS
            loadCustomLocationsIntoMemory();

            // Initialize route with 3 stops: START > STOP 1 > END
            initializeDefaultRoute();
            
            // Setup navigation
            setupNavigation();
            
            // Auto-save on changes
            setupAutoSave();
            
            // Initialize the current active page content
            const activePage = document.querySelector('.nav-item.active');
            if (activePage && activePage.dataset.page) {
                initializePage(activePage.dataset.page);
            }
        }

        function loadCustomLocationsIntoMemory() {
            const customLocations = JSON.parse(localStorage.getItem('alm_custom_locations') || '{}');
            Object.assign(ALM_LOCATIONS, customLocations);
        }

        // Print Functions
        function printCurrentView() {
            // Set print date attribute
            const pageHeader = document.querySelector('.page-header');
            if (pageHeader) {
                pageHeader.setAttribute('data-print-date', new Date().toLocaleDateString());
            }
            
            window.print();
        }

        function printFilteredData() {
            // For history page, ensure we're showing filtered data
            if (document.getElementById('history-page').classList.contains('active')) {
                const hasFilters = document.getElementById('filter-month').value || 
                                  document.getElementById('filter-purpose').value || 
                                  document.getElementById('filter-status').value;
                
                if (!hasFilters) {
                    showToast('No filters applied. Use "Print Current View" instead.', 'warning');
                    return;
                }
            }
            
            printCurrentView();
        }

        function printCostReport() {
            // Switch to cost page if not already there
            const costPage = document.getElementById('cost-page');
            if (!costPage.classList.contains('active')) {
                document.querySelector('.nav-item[data-page="cost"]').click();
                setTimeout(printCurrentView, 500); // Wait for page to load
            } else {
                printCurrentView();
            }
        }

        function printMonthlySummary() {
            printCostReport(); // Same as cost report for now
        }

        function initializeDefaultRoute() {
            // Clear any existing route
            currentRoute = [];
            document.getElementById('stops-list').innerHTML = '';
            
            // Add START stop (Home)
            addStopAtIndex(0, 'start', 'START', true);
            
            // Add middle stop (empty)
            addStopAtIndex(1, 'end', 'STOP 1 - END', false);
            
            // Update counters and buttons
            updateStopCounter();
            updateAddStopButton();
        }

        function addStopAtIndex(index, indicatorClass, labelText, autoSelectHome) {
            const stopsList = document.getElementById('stops-list');
            
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.dataset.index = index;
            
            stopItem.innerHTML = `
                <div class="stop-indicator ${indicatorClass}"></div>
                <div class="stop-label">${labelText}</div>
                <select class="stop-select" onchange="updateRoute(${index})">
                    <option value="">Choose location...</option>
                    ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                        `<option value="${key}">${loc.name}</option>`
                    ).join('')}
                </select>
                <div class="stop-distance" style="display: none;">0 mi</div>
                ${index > 0 ? `<button class="stop-remove" onclick="removeStop(${index})">√ó</button>` : ''}
            `;
            
            stopsList.appendChild(stopItem);
            currentRoute.push({ location: null, distance: 0 });
            
            // Auto-select Home for first stop
            if (autoSelectHome) {
                const select = stopItem.querySelector('select');
                select.value = 'home';
                currentRoute[index].location = 'home';
            }
        }

        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item[data-page]');
            const pages = document.querySelectorAll('.page');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPage = item.dataset.page;
                    
                    // Update active nav item
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update active page
                    pages.forEach(page => page.classList.remove('active'));
                    const pageElement = document.getElementById(`${targetPage}-page`);
                    if (pageElement) {
                        pageElement.classList.add('active');
                        
                        // Initialize page-specific content
                        initializePage(targetPage);
                    }
                });
            });
        }

        function initializePage(pageType) {
            switch(pageType) {
                case 'history':
                    loadTripHistory();
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'matrix':
                    loadDistanceMatrix();
                    break;
                case 'charts':
                    loadCharts();
                    break;
                case 'cost':
                    loadCostReport();
                    break;
                case 'changelog':
                    loadChangelog();
                    break;
            }
        }

        // Trip History Functions
        function loadTripHistory() {
            const routes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            const container = document.getElementById('history-table-container');
            
            if (routes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No trips recorded yet</p>';
                return;
            }
            
            const filteredRoutes = applyHistoryFilters(routes);
            renderHistoryTable(filteredRoutes);
        }

        function applyHistoryFilters(routes) {
            const monthFilter = document.getElementById('filter-month')?.value;
            const purposeFilter = document.getElementById('filter-purpose')?.value;
            const statusFilter = document.getElementById('filter-status')?.value;
            
            return routes.filter(route => {
                const routeMonth = route.date.substring(0, 7); // YYYY-MM
                
                if (monthFilter && routeMonth !== monthFilter) return false;
                if (purposeFilter && route.purpose !== purposeFilter) return false;
                if (statusFilter) {
                    if (statusFilter === 'reimbursable' && !route.reimbursable) return false;
                    if (statusFilter === 'non-reimbursable' && route.reimbursable) return false;
                    if (statusFilter === 'synced' && !route.synced) return false;
                    if (statusFilter === 'unsynced' && route.synced) return false;
                }
                
                return true;
            });
        }

        function renderHistoryTable(routes) {
            const container = document.getElementById('history-table-container');
            
            const table = document.createElement('table');
            table.className = 'data-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Purpose</th>
                        <th>Route</th>
                        <th>Miles</th>
                        <th>Cost</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${routes.map(route => `
                        <tr>
                            <td>${formatDate(route.date)}</td>
                            <td>${route.purpose}</td>
                            <td>${formatRoute(route.stops)}</td>
                            <td>${route.totalMiles?.toFixed(1) || '0'}</td>
                            <td>$${route.cost?.toFixed(2) || '0.00'}</td>
                            <td>
                                <span class="status-badge ${route.reimbursable ? 'reimbursable' : 'non-reimbursable'}">
                                    ${route.reimbursable ? 'Reimbursable' : 'Non-Reimbursable'}
                                </span>
                                <span class="status-badge ${route.synced ? 'synced' : 'unsynced'}">
                                    ${route.synced ? 'Synced' : 'Unsynced'}
                                </span>
                            </td>
                            <td>
                                <button class="conflict-btn skip" onclick="deleteRoute('${route.id}')" style="padding: 4px 8px; font-size: 10px;">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        function filterHistory() {
            loadTripHistory();
        }

        function clearFilters() {
            document.getElementById('filter-month').value = '';
            document.getElementById('filter-purpose').value = '';
            document.getElementById('filter-status').value = '';
            loadTripHistory();
        }

        function deleteRoute(routeId) {
            if (!confirm('Are you sure you want to delete this route?')) return;
            
            const routes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            const updatedRoutes = routes.filter(r => r.id !== routeId);
            localStorage.setItem('alm_routes', JSON.stringify(updatedRoutes));
            
            showToast('Route deleted', 'success');
            loadTripHistory();
        }

        // Locations Functions
        function loadLocations() {
            const container = document.getElementById('locations-grid');
            
            // Get custom locations from localStorage
            const customLocations = JSON.parse(localStorage.getItem('alm_custom_locations') || '{}');
            
            // Combine ALM locations with custom locations
            const allLocations = { ...ALM_LOCATIONS, ...customLocations };
            
            const locationCards = Object.entries(allLocations).map(([key, location]) => {
                const isCustom = !ALM_LOCATIONS[key];
                return `
                    <div class="location-card">
                        <div class="location-name">${location.name} ${isCustom ? '(Custom)' : ''}</div>
                        <div class="location-type ${location.type}">${location.type}</div>
                        <div class="location-address">${location.address}</div>
                        <div class="location-coords">${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</div>
                        ${isCustom ? `<button class="conflict-btn skip" onclick="deleteCustomLocation('${key}')" style="margin-top: 10px; padding: 4px 8px; font-size: 10px;">Delete</button>` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = locationCards;
        }

        async function geocodeAddress() {
            const address = document.getElementById('new-location-address').value.trim();
            
            if (!address) {
                showToast('Please enter an address first', 'warning');
                return;
            }
            
            const geocodeBtn = document.getElementById('geocode-btn');
            geocodeBtn.disabled = true;
            geocodeBtn.textContent = 'üîÑ Getting...';
            
            try {
                // Use Google Maps Geocoding API
                const geocoder = new google.maps.Geocoder();
                
                const result = await new Promise((resolve, reject) => {
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            resolve(results[0]);
                        } else {
                            reject(new Error(`Geocoding failed: ${status}`));
                        }
                    });
                });
                
                const location = result.geometry.location;
                document.getElementById('new-location-lat').value = location.lat().toFixed(6);
                document.getElementById('new-location-lng').value = location.lng().toFixed(6);
                
                showToast('Coordinates found successfully', 'success');
                
            } catch (error) {
                console.error('Geocoding error:', error);
                showToast('Could not find coordinates. Please enter manually.', 'error');
            } finally {
                geocodeBtn.disabled = false;
                geocodeBtn.textContent = 'üìç Get Coordinates';
            }
        }

        function addNewLocation() {
            const name = document.getElementById('new-location-name').value.trim();
            const address = document.getElementById('new-location-address').value.trim();
            const type = document.getElementById('new-location-type').value;
            const lat = parseFloat(document.getElementById('new-location-lat').value);
            const lng = parseFloat(document.getElementById('new-location-lng').value);
            
            // Validation
            if (!name || !address || !type) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            if (isNaN(lat) || isNaN(lng)) {
                showToast('Please provide valid coordinates', 'warning');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                showToast('Coordinates are out of valid range', 'error');
                return;
            }
            
            // Generate unique key
            const key = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 20) + '_' + Date.now();
            
            // Check if location already exists
            const customLocations = JSON.parse(localStorage.getItem('alm_custom_locations') || '{}');
            const allLocations = { ...ALM_LOCATIONS, ...customLocations };
            
            const existingLocation = Object.values(allLocations).find(loc => 
                loc.name.toLowerCase() === name.toLowerCase() ||
                (Math.abs(loc.lat - lat) < 0.001 && Math.abs(loc.lng - lng) < 0.001)
            );
            
            if (existingLocation) {
                showToast('A location with this name or coordinates already exists', 'warning');
                return;
            }
            
            // Create new location
            const newLocation = {
                name: name,
                address: address,
                lat: lat,
                lng: lng,
                type: type
            };
            
            // Save to localStorage
            customLocations[key] = newLocation;
            localStorage.setItem('alm_custom_locations', JSON.stringify(customLocations));
            
            // Update ALM_LOCATIONS for immediate use
            ALM_LOCATIONS[key] = newLocation;
            
            // Clear form
            document.getElementById('new-location-name').value = '';
            document.getElementById('new-location-address').value = '';
            document.getElementById('new-location-lat').value = '';
            document.getElementById('new-location-lng').value = '';
            document.getElementById('new-location-type').value = 'dealership';
            
            // Refresh locations display
            loadLocations();
            
            // Update route builder dropdowns
            updateRouteBuilderLocations();
            
            showToast(`Location "${name}" added successfully`, 'success');
        }

        function deleteCustomLocation(key) {
            if (!key.startsWith('custom_')) {
                showToast('Cannot delete built-in ALM locations', 'error');
                return;
            }
            
            const customLocations = JSON.parse(localStorage.getItem('alm_custom_locations') || '{}');
            const locationName = customLocations[key]?.name || 'Unknown';
            
            if (!confirm(`Are you sure you want to delete "${locationName}"?`)) {
                return;
            }
            
            // Remove from storage
            delete customLocations[key];
            localStorage.setItem('alm_custom_locations', JSON.stringify(customLocations));
            
            // Remove from runtime locations
            delete ALM_LOCATIONS[key];
            
            // Refresh locations display
            loadLocations();
            
            // Update route builder dropdowns
            updateRouteBuilderLocations();
            
            showToast(`Location "${locationName}" deleted`, 'success');
        }

        function updateRouteBuilderLocations() {
            // Update all route builder dropdown menus
            const selects = document.querySelectorAll('.stop-select');
            selects.forEach(select => {
                const currentValue = select.value;
                const options = Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                    `<option value="${key}" ${currentValue === key ? 'selected' : ''}>${loc.name}</option>`
                ).join('');
                
                select.innerHTML = `<option value="">Choose location...</option>${options}`;
            });
        }

        // Distance Matrix Functions
        function loadDistanceMatrix() {
            const container = document.getElementById('distance-matrix-container');
            const cachedDistances = JSON.parse(localStorage.getItem('maps_distances_v2') || '{}');
            
            // Use all locations including custom ones
            const locations = Object.entries(ALM_LOCATIONS);
            
            let tableHTML = '<table class="data-table distance-matrix"><thead><tr><th style="min-width: 120px;"></th>';
            locations.forEach(([key, loc]) => {
                const displayName = loc.name.replace('ALM ', '').replace('Custom ', '');
                tableHTML += `<th class="location-header" style="min-width: 80px;">${displayName}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            locations.forEach(([fromKey, fromLoc]) => {
                const fromDisplayName = fromLoc.name.replace('ALM ', '').replace('Custom ', '');
                tableHTML += `<tr><td class="location-header" style="min-width: 120px;">${fromDisplayName}</td>`;
                
                locations.forEach(([toKey, toLoc]) => {
                    if (fromKey === toKey) {
                        tableHTML += '<td class="distance-cell">-</td>';
                    } else {
                        const cacheKey = `${fromKey}_${toKey}`;
                        const reverseKey = `${toKey}_${fromKey}`;
                        const distance = cachedDistances[cacheKey] || cachedDistances[reverseKey];
                        
                        if (distance) {
                            tableHTML += `<td class="distance-cell">${distance.toFixed(1)} mi</td>`;
                        } else {
                            // Calculate haversine as fallback
                            const haversineDist = haversineDistance(fromLoc.lat, fromLoc.lng, toLoc.lat, toLoc.lng) * 1.25;
                            tableHTML += `<td class="distance-cell unavailable" title="Estimated">${haversineDist.toFixed(1)} mi*</td>`;
                        }
                    }
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            
            // Add legend for estimated distances
            tableHTML += '<div style="margin-top: 10px; font-size: 11px; color: #666;">* Estimated distances (not from Google Maps)</div>';
            
            container.innerHTML = tableHTML;
        }

        // Charts Functions
        let monthlyChart = null;
        let purposeChart = null;

        function loadCharts() {
            const routes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            
            // Destroy existing charts
            if (monthlyChart) {
                monthlyChart.destroy();
            }
            if (purposeChart) {
                purposeChart.destroy();
            }
            
            createMonthlyChart(routes);
            createPurposeChart(routes);
            updateStatsGrid(routes);
        }

        function createMonthlyChart(routes) {
            const ctx = document.getElementById('monthly-chart');
            if (!ctx) return;
            
            // Group routes by month
            const monthlyData = {};
            routes.forEach(route => {
                const month = route.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = 0;
                }
                monthlyData[month] += route.totalMiles || 0;
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(month => {
                const date = new Date(month + '-01');
                return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const data = sortedMonths.map(month => monthlyData[month]);
            
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Miles',
                        data: data,
                        backgroundColor: '#ffa726',
                        borderColor: '#ff9800',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#666'
                            },
                            grid: {
                                color: '#333'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#666'
                            },
                            grid: {
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }

        function createPurposeChart(routes) {
            const ctx = document.getElementById('purpose-chart');
            if (!ctx) return;
            
            // Group routes by purpose
            const purposeData = {};
            routes.forEach(route => {
                const purpose = route.purpose || 'Unknown';
                if (!purposeData[purpose]) {
                    purposeData[purpose] = 0;
                }
                purposeData[purpose] += route.totalMiles || 0;
            });
            
            const colors = ['#ffa726', '#22c55e', '#ef4444', '#3b82f6', '#8b5cf6', '#f59e0b'];
            const labels = Object.keys(purposeData);
            const data = Object.values(purposeData);
            
            purposeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#666',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function updateStatsGrid(routes) {
            const container = document.getElementById('stats-summary');
            
            const totalRoutes = routes.length;
            const totalMiles = routes.reduce((sum, r) => sum + (r.totalMiles || 0), 0);
            const totalCost = routes.reduce((sum, r) => sum + (r.cost || 0), 0);
            const reimbursableRoutes = routes.filter(r => r.reimbursable).length;
            const avgMilesPerTrip = totalRoutes > 0 ? (totalMiles / totalRoutes) : 0;
            const syncedRoutes = routes.filter(r => r.synced).length;
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalRoutes}</div>
                    <div class="stat-label">Total Trips</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalMiles.toFixed(1)}</div>
                    <div class="stat-label">Total Miles</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">$${totalCost.toFixed(2)}</div>
                    <div class="stat-label">Total Cost</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${reimbursableRoutes}</div>
                    <div class="stat-label">Reimbursable Trips</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${avgMilesPerTrip.toFixed(1)}</div>
                    <div class="stat-label">Avg Miles/Trip</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${syncedRoutes}</div>
                    <div class="stat-label">Synced Trips</div>
                </div>
            `;
            
            container.innerHTML = statsHTML;
        }

        // Cost Report Functions
        function loadCostReport() {
            const routes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            
            // Update summary cards
            const totalMiles = routes.reduce((sum, r) => sum + (r.totalMiles || 0), 0);
            const totalReimbursement = routes.reduce((sum, r) => sum + (r.cost || 0), 0);
            
            document.getElementById('total-miles-card').textContent = totalMiles.toFixed(1);
            document.getElementById('total-reimbursement-card').textContent = '$' + totalReimbursement.toFixed(2);
            
            // Create monthly breakdown table
            createMonthlyCostTable(routes);
        }

        function createMonthlyCostTable(routes) {
            const container = document.getElementById('monthly-cost-table');
            
            // Group by month
            const monthlyData = {};
            routes.forEach(route => {
                const month = route.date.substring(0, 7);
                if (!monthlyData[month]) {
                    monthlyData[month] = {
                        trips: 0,
                        miles: 0,
                        cost: 0,
                        reimbursableTrips: 0
                    };
                }
                
                monthlyData[month].trips++;
                monthlyData[month].miles += route.totalMiles || 0;
                monthlyData[month].cost += route.cost || 0;
                if (route.reimbursable) {
                    monthlyData[month].reimbursableTrips++;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            
            const table = document.createElement('table');
            table.className = 'data-table';
            
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Total Trips</th>
                        <th>Reimbursable Trips</th>
                        <th>Total Miles</th>
                        <th>Total Cost</th>
                        <th>Avg Cost/Trip</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedMonths.map(month => {
                        const data = monthlyData[month];
                        const avgCost = data.trips > 0 ? (data.cost / data.trips) : 0;
                        const monthName = new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        
                        return `
                            <tr>
                                <td>${monthName}</td>
                                <td>${data.trips}</td>
                                <td>${data.reimbursableTrips}</td>
                                <td>${data.miles.toFixed(1)}</td>
                                <td>$${data.cost.toFixed(2)}</td>
                                <td>$${avgCost.toFixed(2)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
            
            container.innerHTML = '';
            container.appendChild(table);
        }

        // Changelog Functions
        function loadChangelog() {
            const container = document.getElementById('changelog-content');
            
            const changelog = [
                {
                    version: 'v13',
                    date: 'February 2026',
                    features: [
                        'Print-Friendly Views - Professional printing for reports and history',
                        'Add New Locations - Create custom locations with geocoding support',
                        'Fixed Distance Matrix Scrolling - Improved horizontal scroll on mobile',
                        'Complete Changelog - All versions from v1-v13 documented',
                        'Enhanced Print Styles - Clean black/white formatting for expense reports'
                    ]
                },
                {
                    version: 'v12',
                    date: 'February 2026',
                    features: [
                        'Complete Dashboard - All navigation tabs now functional',
                        'Trip History - View, filter, and manage all saved routes',
                        'Interactive Charts - Monthly miles and purpose breakdown',
                        'Cost Reporting - Detailed reimbursement calculations',
                        'Locations Directory - All ALM locations with coordinates',
                        'Distance Matrix - Cached distance lookup grid',
                        'Working Excel Import/Export with SheetJS integration',
                        'Enhanced navigation with page-specific initialization'
                    ]
                },
                {
                    version: 'v11',
                    date: 'February 2026',
                    features: [
                        'Conflict Resolution - Smart import conflict detection',
                        'Date Adjustment - Automatically suggest available dates',
                        'Bulk Actions - Skip All, Overwrite All options',
                        'Side-by-side Comparison - Existing vs incoming data',
                        'Professional Modal UI - Sophisticated conflict interface'
                    ]
                },
                {
                    version: 'v10',
                    date: 'February 2026',
                    features: [
                        'Map Preview - Google Maps integration for route visualization',
                        'Custom Markers - H (Home), C (Corporate), numbered (ALM locations)',
                        'Route Visualization - Amber polylines with waypoints',
                        'Toggle Show/Hide - Collapsible map interface',
                        'Mobile Responsive - Works on all device sizes'
                    ]
                },
                {
                    version: 'v9',
                    date: 'February 2026',
                    features: [
                        'Auto-save Drafts - Routes save automatically on changes',
                        'Draft Recovery - Resume interrupted route building',
                        'Draft Banner - Clear notification of unsaved work',
                        'LocalStorage Integration - Persistent draft storage'
                    ]
                },
                {
                    version: 'v8',
                    date: 'February 2026',
                    features: [
                        'Cost Calculator - Reimbursement calculations',
                        'IRS Rate Integration - $0.70/mile (2025 standard)',
                        'Monthly Cost Breakdown - Detailed reporting',
                        'Summary Cards - Total reimbursement display'
                    ]
                },
                {
                    version: 'v7',
                    date: 'February 2026',
                    features: [
                        'Charts Integration - Monthly miles bar chart',
                        'Purpose Analysis - Pie chart breakdown',
                        'Chart.js Integration - Interactive visualizations',
                        'Dark Theme Charts - Consistent styling'
                    ]
                },
                {
                    version: 'v6',
                    date: 'February 2026',
                    features: [
                        'Excel Import - Read previously downloaded files',
                        'Smart Merge - Only import new routes, check date+miles',
                        'Parse Summary + Detailed Legs sheets',
                        'Preserve synced status from file'
                    ]
                },
                {
                    version: 'v5',
                    date: 'February 2026',
                    features: [
                        'Force Resync - Per-row "Retry" button on unsynced routes',
                        'Sync All Unsynced - Bulk button at top of history',
                        'Auto-retry after sign-in - Reprocess failed syncs',
                        'Error handling improvements'
                    ]
                },
                {
                    version: 'v4',
                    date: 'February 2026',
                    features: [
                        'Google Sheets Sync Fixes - Fixed URL encoding bugs',
                        'Error surfacing in toasts for debugging',
                        'Token expiry handling with re-auth flow',
                        'Improved sync reliability'
                    ]
                },
                {
                    version: 'v3',
                    date: 'February 2026',
                    features: [
                        'Google Integration - Switched to Google Maps Distance Matrix API',
                        'Google Sheets Auto-backup via OAuth 2.0',
                        'Summary + Detailed Legs tabs sync',
                        'Header status pills show connection state'
                    ]
                },
                {
                    version: 'v2',
                    date: 'February 2026',
                    features: [
                        'Multi-Stop Route Builder - Up to 6 stops per route (5 legs)',
                        'Visual connector UI - Green start, amber middle, red end',
                        'Live leg-by-leg mileage with badges',
                        'Zero-mile days supported (N/R only)',
                        'Expandable leg detail in history',
                        'Corrected 6 location addresses via web search',
                        'Added dedicated Locations page'
                    ]
                },
                {
                    version: 'v1',
                    date: 'February 2026',
                    features: [
                        'Initial Release - Single A‚ÜíB trip logging',
                        'OpenRouteService API for driving distances',
                        '10 ALM locations with haversine estimates as fallback',
                        'Distance matrix view and trip history',
                        'Excel export functionality',
                        'Home ‚Üî Corporate marked non-reimbursable',
                        'Dark theme with amber accent colors'
                    ]
                }
            ];
            
            const changelogHTML = changelog.map(version => `
                <div class="changelog-version">
                    <div class="changelog-header">
                        <div class="version-number">${version.version}</div>
                        <div class="version-date">${version.date}</div>
                    </div>
                    <ul class="changelog-features">
                        ${version.features.map(feature => `<li>${feature}</li>`).join('')}
                    </ul>
                </div>
            `).join('');
            
            container.innerHTML = changelogHTML;
        }

        function setupAutoSave() {
            // Auto-save draft when inputs change
            const inputs = ['trip-date', 'trip-purpose'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', saveDraft);
                    element.addEventListener('change', saveDraft);
                }
            });
        }

        function addStop() {
            if (currentRoute.length >= MAX_STOPS) {
                showToast('Maximum 6 stops allowed', 'warning');
                return;
            }

            const stopsList = document.getElementById('stops-list');
            const stopIndex = currentRoute.length;
            
            const stopItem = document.createElement('div');
            stopItem.className = 'stop-item';
            stopItem.dataset.index = stopIndex;
            
            // All added stops are middle stops initially
            const indicatorClass = 'middle';
            const labelText = `STOP ${stopIndex} - END`;
            
            stopItem.innerHTML = `
                <div class="stop-indicator ${indicatorClass}"></div>
                <div class="stop-label">${labelText}</div>
                <select class="stop-select" onchange="updateRoute(${stopIndex})">
                    <option value="">Choose location...</option>
                    ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                        `<option value="${key}">${loc.name}</option>`
                    ).join('')}
                </select>
                <div class="stop-distance" style="display: none;">0 mi</div>
                <button class="stop-remove" onclick="removeStop(${stopIndex})">√ó</button>
            `;
            
            stopsList.appendChild(stopItem);
            currentRoute.push({ location: null, distance: 0 });
            
            // Update labels to ensure the last stop is marked as END
            updateStopLabels();
            
            // Update add button and stop count
            updateStopCounter();
            updateAddStopButton();
            saveDraft();
        }

        function updateStopCounter() {
            const validStops = currentRoute.filter(stop => stop.location).length;
            const legs = Math.max(0, validStops - 1);
            const counterText = `${validStops} locations ‚Ä¢ ${legs} legs`;
            
            const stopCount = document.getElementById('stop-count');
            if (stopCount) {
                stopCount.textContent = counterText;
            }
            
            // Update the add button text to reflect current state
            const addBtn = document.getElementById('add-stop-btn');
            if (addBtn) {
                const totalStops = currentRoute.length;
                const currentLegs = Math.max(0, totalStops - 1);
                addBtn.innerHTML = `+ Add Stop<span id="stop-count">${totalStops} locations ‚Ä¢ ${currentLegs} legs</span>`;
            }
        }

        function removeStop(index) {
            if (index === 0) {
                showToast('Cannot remove START location', 'warning');
                return;
            }
            
            if (currentRoute.length <= 2) {
                showToast('Must have at least 2 stops', 'warning');
                return;
            }
            
            const stopItem = document.querySelector(`[data-index="${index}"]`);
            if (stopItem) {
                stopItem.remove();
            }
            
            currentRoute.splice(index, 1);
            
            // Re-index remaining stops
            const stopItems = document.querySelectorAll('.stop-item');
            stopItems.forEach((item, i) => {
                item.dataset.index = i;
                const select = item.querySelector('select');
                const removeBtn = item.querySelector('.stop-remove');
                
                // Update onchange and onclick attributes
                select.setAttribute('onchange', `updateRoute(${i})`);
                if (removeBtn && i > 0) {
                    removeBtn.setAttribute('onclick', `removeStop(${i})`);
                }
            });
            
            // Update all labels and indicators
            updateStopLabels();
            updateStopCounter();
            updateAddStopButton();
            calculateRoute();
            saveDraft();
        }

        function updateRoute(index) {
            const stopItem = document.querySelector(`[data-index="${index}"]`);
            const select = stopItem.querySelector('select');
            const locationKey = select.value;
            
            if (locationKey && ALM_LOCATIONS[locationKey]) {
                currentRoute[index].location = locationKey;
                
                // Update labels and indicators
                updateStopLabels();
                updateStopCounter();
                calculateRoute();
                saveDraft();
            }
        }

        function updateStopLabels() {
            const stopItems = document.querySelectorAll('.stop-item');
            stopItems.forEach((item, i) => {
                const label = item.querySelector('.stop-label');
                const indicator = item.querySelector('.stop-indicator');
                
                if (i === 0) {
                    // First stop is always START
                    indicator.className = 'stop-indicator start';
                    label.textContent = 'START';
                } else if (i === currentRoute.length - 1) {
                    // Last stop is always END
                    indicator.className = 'stop-indicator end';
                    label.textContent = `STOP ${i} - END`;
                } else {
                    // Middle stops
                    indicator.className = 'stop-indicator middle';
                    label.textContent = `STOP ${i}`;
                }
            });
        }

        function updateAddStopButton() {
            const addBtn = document.getElementById('add-stop-btn');
            addBtn.style.display = currentRoute.length >= MAX_STOPS ? 'none' : 'inline-flex';
        }

        async function calculateRoute() {
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (validStops.length < 2) {
                resetDistanceDisplay();
                return;
            }

            try {
                const distanceMatrix = await getDistanceMatrix(validStops);
                updateDistanceDisplay(distanceMatrix);
                updateButtons();
            } catch (error) {
                console.error('Distance calculation error:', error);
                showToast('Error calculating distances', 'error');
            }
        }

        async function getDistanceMatrix(stops) {
            const service = new google.maps.DistanceMatrixService();
            const origins = stops.slice(0, -1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return new google.maps.LatLng(loc.lat, loc.lng);
            });
            const destinations = stops.slice(1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return new google.maps.LatLng(loc.lat, loc.lng);
            });

            return new Promise((resolve, reject) => {
                service.getDistanceMatrix({
                    origins: origins,
                    destinations: destinations,
                    travelMode: google.maps.TravelMode.DRIVING,
                    unitSystem: google.maps.UnitSystem.IMPERIAL,
                    avoidHighways: false,
                    avoidTolls: false
                }, (response, status) => {
                    if (status === google.maps.DistanceMatrixStatus.OK) {
                        resolve(response);
                    } else {
                        reject(new Error(`Distance Matrix error: ${status}`));
                    }
                });
            });
        }

        function updateDistanceDisplay(distanceMatrix) {
            let totalMiles = 0;
            const elements = distanceMatrix.rows[0].elements;
            
            // Update individual leg distances
            elements.forEach((element, index) => {
                if (element.status === 'OK') {
                    const miles = Math.round(element.distance.value * 0.000621371 * 100) / 100;
                    totalMiles += miles;
                    
                    // Update leg badge
                    const stopItem = document.querySelector(`[data-index="${index + 1}"]`);
                    if (stopItem) {
                        const badge = stopItem.querySelector('.stop-distance');
                        badge.textContent = `${miles} mi`;
                        badge.style.display = 'block';
                    }
                }
            });
            
            // Update total display
            totalDistance = totalMiles;
            document.getElementById('total-value').innerHTML = `${totalMiles.toFixed(1)}<span class="total-unit">miles</span>`;
            document.getElementById('day-total').style.display = 'block';
            
            // Update top bar total
            document.getElementById('total-miles-display').textContent = totalMiles.toFixed(1);
            
            // Update status pill
            updateMapsStatus('connected');
        }

        function resetDistanceDisplay() {
            totalDistance = 0;
            document.getElementById('day-total').style.display = 'none';
            document.getElementById('total-miles-display').textContent = '0.0';
            
            // Hide leg badges
            document.querySelectorAll('.stop-distance').forEach(badge => {
                badge.style.display = 'none';
            });
            
            updateButtons();
        }

        function updateButtons() {
            const previewBtn = document.getElementById('preview-btn');
            const saveBtn = document.getElementById('save-btn');
            const hasValidRoute = currentRoute.filter(s => s.location).length >= 2;
            
            previewBtn.disabled = !hasValidRoute || totalDistance === 0;
            saveBtn.disabled = !hasValidRoute || totalDistance === 0;
        }

        // Google Maps Integration
        function initMap() {
            isMapInitialized = true;
            
            // Initialize map (hidden by default)
            map = new google.maps.Map(document.createElement('div'), {
                zoom: 10,
                center: { lat: 33.9490, lng: -84.3880 }, // Atlanta center
                styles: [
                    {
                        "elementType": "geometry",
                        "stylers": [{"color": "#1d2c4d"}]
                    },
                    {
                        "elementType": "labels.text.fill",
                        "stylers": [{"color": "#8ec3b9"}]
                    },
                    {
                        "elementType": "labels.text.stroke",
                        "stylers": [{"color": "#1a3646"}]
                    }
                    // Add more dark theme styles here...
                ]
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                polylineOptions: {
                    strokeColor: '#ffa726',
                    strokeOpacity: 1.0,
                    strokeWeight: 4
                }
            });

            updateMapsStatus('connected');
        }

        function previewRoute() {
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (validStops.length < 2) {
                showToast('Need at least 2 stops to preview route', 'warning');
                return;
            }

            if (!isMapInitialized) {
                showToast('Map is still loading, please wait...', 'warning');
                return;
            }

            // Show map preview section
            const mapSection = document.getElementById('map-preview');
            const mapContainer = document.getElementById('map-container');
            
            mapSection.style.display = 'block';
            
            // Replace placeholder with actual map
            mapContainer.innerHTML = '';
            map.getDiv().style.width = '100%';
            map.getDiv().style.height = '100%';
            mapContainer.appendChild(map.getDiv());
            
            // Trigger map resize
            setTimeout(() => {
                google.maps.event.trigger(map, 'resize');
                displayRouteOnMap(validStops);
            }, 100);
            
            // Update toggle button
            document.getElementById('map-toggle-btn').textContent = 'Hide Map';
        }

        function displayRouteOnMap(stops) {
            const waypoints = stops.slice(1, -1).map(stop => {
                const loc = ALM_LOCATIONS[stop.location];
                return {
                    location: new google.maps.LatLng(loc.lat, loc.lng),
                    stopover: true
                };
            });

            const start = ALM_LOCATIONS[stops[0].location];
            const end = ALM_LOCATIONS[stops[stops.length - 1].location];

            const request = {
                origin: new google.maps.LatLng(start.lat, start.lng),
                destination: new google.maps.LatLng(end.lat, end.lng),
                waypoints: waypoints,
                travelMode: google.maps.TravelMode.DRIVING,
                optimizeWaypoints: false
            };

            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    
                    // Add custom markers for ALM locations
                    addCustomMarkers(stops);
                } else {
                    console.error('Directions request failed:', status);
                    showToast('Failed to load route preview', 'error');
                }
            });
        }

        function addCustomMarkers(stops) {
            stops.forEach((stop, index) => {
                const location = ALM_LOCATIONS[stop.location];
                const isHome = location.type === 'home';
                const isCorporate = location.type === 'corporate';
                
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    icon: {
                        url: `data:image/svg+xml,${encodeURIComponent(`
                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="14" fill="${isHome ? '#22c55e' : isCorporate ? '#ef4444' : '#ffa726'}" stroke="white" stroke-width="2"/>
                                <text x="16" y="20" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">
                                    ${isHome ? 'H' : isCorporate ? 'C' : (index + 1)}
                                </text>
                            </svg>
                        `)}`,
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
            });
        }

        function toggleMapPreview() {
            const mapSection = document.getElementById('map-preview');
            const toggleBtn = document.getElementById('map-toggle-btn');
            
            if (mapSection.style.display === 'none' || !mapSection.style.display) {
                previewRoute();
            } else {
                mapSection.style.display = 'none';
                toggleBtn.textContent = 'Show Map';
            }
        }

        // Route Management
        function clearRoute() {
            currentRoute = [];
            document.getElementById('stops-list').innerHTML = '';
            resetDistanceDisplay();
            
            // Hide map preview
            document.getElementById('map-preview').style.display = 'none';
            
            // Reset form
            document.getElementById('trip-purpose').value = '';
            
            // Initialize with default 3-stop route
            initializeDefaultRoute();
            
            clearDraft();
        }

        function saveRoute() {
            const date = document.getElementById('trip-date').value;
            const purpose = document.getElementById('trip-purpose').value;
            const validStops = currentRoute.filter(stop => stop.location);
            
            if (!date || !purpose || validStops.length < 2 || totalDistance === 0) {
                showToast('Please complete all fields and calculate route', 'warning');
                return;
            }
            
            // Check for non-reimbursable routes
            const isNonReimbursable = checkNonReimbursable(validStops);
            
            const routeData = {
                id: Date.now().toString(),
                date: date,
                purpose: purpose,
                stops: validStops.map(stop => ({
                    location: stop.location,
                    name: ALM_LOCATIONS[stop.location].name
                })),
                totalMiles: totalDistance,
                reimbursable: !isNonReimbursable,
                cost: isNonReimbursable ? 0 : (totalDistance * IRS_RATE),
                timestamp: new Date().toISOString(),
                synced: false
            };
            
            // Save to localStorage
            const existingRoutes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            existingRoutes.push(routeData);
            localStorage.setItem('alm_routes', JSON.stringify(existingRoutes));
            
            // Clear form and draft
            clearRoute();
            clearDraft();
            
            showToast(`Trip saved successfully! ${isNonReimbursable ? '(Non-reimbursable)' : ''}`, 'success');
        }

        function checkNonReimbursable(stops) {
            // Home <-> Corporate is non-reimbursable
            if (stops.length === 2) {
                const [start, end] = stops;
                return (start.location === 'home' && end.location === 'corporate') ||
                       (start.location === 'corporate' && end.location === 'home');
            }
            return false;
        }

        // Draft Management
        function saveDraft() {
            const draftData = {
                date: document.getElementById('trip-date').value,
                purpose: document.getElementById('trip-purpose').value,
                route: currentRoute,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('alm_draft_route', JSON.stringify(draftData));
        }

        function checkDraft() {
            const draft = localStorage.getItem('alm_draft_route');
            if (draft) {
                const draftData = JSON.parse(draft);
                document.getElementById('draft-banner').classList.add('show');
            }
        }

        function resumeDraft() {
            const draft = localStorage.getItem('alm_draft_route');
            if (draft) {
                const draftData = JSON.parse(draft);
                
                // Restore form data
                document.getElementById('trip-date').value = draftData.date || '';
                document.getElementById('trip-purpose').value = draftData.purpose || '';
                
                // Restore route
                if (draftData.route && draftData.route.length > 0) {
                    currentRoute = draftData.route;
                    rebuildStopsList();
                    calculateRoute();
                }
                
                document.getElementById('draft-banner').classList.remove('show');
                showToast('Draft restored successfully', 'success');
            }
        }

        function discardDraft() {
            clearDraft();
            document.getElementById('draft-banner').classList.remove('show');
            showToast('Draft discarded', 'warning');
        }

        function clearDraft() {
            localStorage.removeItem('alm_draft_route');
        }

        function rebuildStopsList() {
            const stopsList = document.getElementById('stops-list');
            stopsList.innerHTML = '';
            
            currentRoute.forEach((stop, index) => {
                const stopItem = document.createElement('div');
                stopItem.className = 'stop-item';
                stopItem.dataset.index = index;
                
                let indicatorClass, labelText;
                if (index === 0) {
                    indicatorClass = 'start';
                    labelText = 'START';
                } else if (index === currentRoute.length - 1) {
                    indicatorClass = 'end';
                    labelText = `STOP ${index} - END`;
                } else {
                    indicatorClass = 'middle';
                    labelText = `STOP ${index}`;
                }
                
                stopItem.innerHTML = `
                    <div class="stop-indicator ${indicatorClass}"></div>
                    <div class="stop-label">${labelText}</div>
                    <select class="stop-select" onchange="updateRoute(${index})">
                        <option value="">Choose location...</option>
                        ${Object.entries(ALM_LOCATIONS).map(([key, loc]) => 
                            `<option value="${key}" ${stop.location === key ? 'selected' : ''}>${loc.name}</option>`
                        ).join('')}
                    </select>
                    <div class="stop-distance" style="display: none;">0 mi</div>
                    ${index > 0 ? `<button class="stop-remove" onclick="removeStop(${index})">√ó</button>` : ''}
                `;
                
                stopsList.appendChild(stopItem);
            });
            
            updateStopCounter();
            updateAddStopButton();
        }

        // Status Management
        function updateStatus() {
            updateMapsStatus('checking');
            updateSheetsStatus('checking');
            
            // Check Maps API
            if (typeof google !== 'undefined' && google.maps) {
                updateMapsStatus('connected');
            } else {
                setTimeout(() => {
                    if (typeof google !== 'undefined' && google.maps) {
                        updateMapsStatus('connected');
                    } else {
                        updateMapsStatus('disconnected');
                    }
                }, 3000);
            }
            
            // Check Sheets (placeholder for now)
            setTimeout(() => {
                updateSheetsStatus('disconnected');
            }, 1000);
        }

        function updateMapsStatus(status) {
            const pill = document.getElementById('maps-status');
            if (status === 'connected') {
                pill.className = 'status-pill maps-active';
                pill.innerHTML = '‚óè MAPS ACTIVE';
            } else {
                pill.className = 'status-pill sheets-signin'; // red color
                pill.innerHTML = '‚óè MAPS ERROR';
            }
        }

        function updateSheetsStatus(status) {
            const pill = document.getElementById('sheets-status');
            if (status === 'connected') {
                pill.className = 'status-pill maps-active'; // green color
                pill.innerHTML = '‚óè SHEETS CONNECTED';
            } else {
                pill.className = 'status-pill sheets-signin';
                pill.innerHTML = '‚óè SHEETS: SIGN IN';
            }
        }

        // Utility Functions
        function refreshDistances() {
            if (!confirm('This will clear all cached distances and may require recalculation. Continue?')) {
                return;
            }
            
            // Clear the distance cache
            localStorage.removeItem('maps_distances_v2');
            showToast('Distance cache cleared', 'success');
            
            // If we're on the distance matrix page, refresh it
            const matrixPage = document.getElementById('matrix-page');
            if (matrixPage && matrixPage.classList.contains('active')) {
                loadDistanceMatrix();
            }
            
            // Optionally, recalculate distances for current route
            if (currentRoute.length > 1) {
                calculateRoute();
            }
        }

        function downloadExcel() {
            const routes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            
            if (routes.length === 0) {
                showToast('No data to export', 'warning');
                return;
            }
            
            // Create summary worksheet
            const summaryData = [
                ['Date', 'Purpose', 'Start', 'End', 'Total Miles', 'Reimbursable', 'Cost', 'Synced']
            ];
            
            routes.forEach(route => {
                const startLocation = route.stops && route.stops[0] ? route.stops[0].name : 'Unknown';
                const endLocation = route.stops && route.stops[route.stops.length - 1] ? route.stops[route.stops.length - 1].name : 'Unknown';
                
                summaryData.push([
                    route.date,
                    route.purpose || '',
                    startLocation,
                    endLocation,
                    route.totalMiles || 0,
                    route.reimbursable ? 'Yes' : 'No',
                    route.cost || 0,
                    route.synced ? 'Yes' : 'No'
                ]);
            });
            
            // Create detailed legs worksheet
            const detailedData = [
                ['Date', 'Route ID', 'Leg', 'From', 'To', 'Miles']
            ];
            
            routes.forEach(route => {
                if (route.stops && route.stops.length > 1) {
                    for (let i = 0; i < route.stops.length - 1; i++) {
                        const legMiles = calculateLegDistance(route.stops[i], route.stops[i + 1]);
                        detailedData.push([
                            route.date,
                            route.id,
                            i + 1,
                            route.stops[i].name,
                            route.stops[i + 1].name,
                            legMiles
                        ]);
                    }
                }
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Add summary sheet
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Add detailed legs sheet
            const detailedWs = XLSX.utils.aoa_to_sheet(detailedData);
            XLSX.utils.book_append_sheet(wb, detailedWs, 'Detailed Legs');
            
            // Download file
            const today = new Date().toISOString().split('T')[0];
            const filename = `ALM_Mileage_Export_${today}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            showToast(`Exported ${routes.length} routes to ${filename}`, 'success');
        }

        function calculateLegDistance(fromStop, toStop) {
            // Try to get from cache first
            const cachedDistances = JSON.parse(localStorage.getItem('maps_distances_v2') || '{}');
            const cacheKey = `${fromStop.location}_${toStop.location}`;
            
            if (cachedDistances[cacheKey]) {
                return cachedDistances[cacheKey];
            }
            
            // Fallback to haversine calculation
            const from = ALM_LOCATIONS[fromStop.location];
            const to = ALM_LOCATIONS[toStop.location];
            
            if (!from || !to) return 0;
            
            return haversineDistance(from.lat, from.lng, to.lat, to.lng) * 1.25; // 25% multiplier for road distance
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                showToast('Processing Excel file...', 'warning');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        // This would typically use SheetJS to parse the Excel file
                        // For now, we'll simulate some imported data with potential conflicts
                        simulateExcelImport();
                    } catch (error) {
                        console.error('Excel import error:', error);
                        showToast('Error processing Excel file', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }

        function importExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                showToast('Processing Excel file...', 'warning');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Parse the Summary sheet
                        const summarySheetName = workbook.SheetNames.find(name => 
                            name.toLowerCase().includes('summary') || name === 'Sheet1'
                        ) || workbook.SheetNames[0];
                        
                        if (!summarySheetName) {
                            throw new Error('No valid sheet found in Excel file');
                        }
                        
                        const summarySheet = workbook.Sheets[summarySheetName];
                        const summaryData = XLSX.utils.sheet_to_json(summarySheet);
                        
                        const importedRoutes = parseExcelData(summaryData);
                        handleImportedRoutes(importedRoutes);
                        
                    } catch (error) {
                        console.error('Excel import error:', error);
                        showToast('Error processing Excel file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }

        function parseExcelData(data) {
            const routes = [];
            
            data.forEach((row, index) => {
                try {
                    // Handle different possible column names
                    const date = row['Date'] || row['date'] || row['DATE'];
                    const purpose = row['Purpose'] || row['purpose'] || row['PURPOSE'] || '';
                    const startLoc = row['Start'] || row['start'] || row['From'] || row['from'];
                    const endLoc = row['End'] || row['end'] || row['To'] || row['to'];
                    const miles = parseFloat(row['Total Miles'] || row['Miles'] || row['total_miles'] || row['miles'] || 0);
                    const reimbursable = String(row['Reimbursable'] || row['reimbursable'] || 'Yes').toLowerCase() === 'yes';
                    const cost = parseFloat(row['Cost'] || row['cost'] || (miles * IRS_RATE));
                    
                    if (!date) {
                        console.warn(`Skipping row ${index + 1}: No date found`);
                        return;
                    }
                    
                    // Convert Excel date if needed
                    let formattedDate;
                    if (typeof date === 'number') {
                        // Excel date number
                        const excelDate = new Date((date - 25569) * 86400 * 1000);
                        formattedDate = excelDate.toISOString().split('T')[0];
                    } else {
                        // String date
                        formattedDate = new Date(date).toISOString().split('T')[0];
                    }
                    
                    // Create stops array
                    const stops = [];
                    if (startLoc) {
                        const startKey = findLocationKey(startLoc);
                        if (startKey) {
                            stops.push({ location: startKey, name: ALM_LOCATIONS[startKey].name });
                        }
                    }
                    if (endLoc && endLoc !== startLoc) {
                        const endKey = findLocationKey(endLoc);
                        if (endKey) {
                            stops.push({ location: endKey, name: ALM_LOCATIONS[endKey].name });
                        }
                    }
                    
                    const route = {
                        id: 'import_' + Date.now() + '_' + index,
                        date: formattedDate,
                        purpose: purpose,
                        stops: stops,
                        totalMiles: miles,
                        reimbursable: reimbursable,
                        cost: cost,
                        timestamp: new Date().toISOString(),
                        synced: false
                    };
                    
                    routes.push(route);
                    
                } catch (error) {
                    console.warn(`Error parsing row ${index + 1}:`, error);
                }
            });
            
            return routes;
        }

        function findLocationKey(locationName) {
            const name = locationName.toLowerCase();
            
            for (const [key, location] of Object.entries(ALM_LOCATIONS)) {
                if (location.name.toLowerCase().includes(name) || 
                    name.includes(location.name.toLowerCase()) ||
                    name.includes(key)) {
                    return key;
                }
            }
            
            return null;
        }

        function handleImportedRoutes(importedRoutes) {
            if (importedRoutes.length === 0) {
                showToast('No valid routes found in Excel file', 'warning');
                return;
            }
            
            const existingRoutes = JSON.parse(localStorage.getItem('alm_routes') || '[]');
            const conflicts = detectConflicts(importedRoutes, existingRoutes);
            
            if (conflicts.length > 0) {
                // Show conflict resolution modal
                showConflictModal(conflicts);
            } else {
                // No conflicts, proceed with direct import
                const updatedRoutes = [...existingRoutes, ...importedRoutes];
                localStorage.setItem('alm_routes', JSON.stringify(updatedRoutes));
                showToast(`Successfully imported ${importedRoutes.length} routes`, 'success');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Handle Google Maps API load error
        window.gm_authFailure = function() {
            updateMapsStatus('disconnected');
            showToast('Google Maps authentication failed', 'error');
        };
    </script>
</body>
</html>